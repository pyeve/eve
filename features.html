<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Features &mdash; Eve 0.8 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Eve 0.8 documentation" href="index.html" />
    <link rel="next" title="Configuration" href="config.html" />
    <link rel="prev" title="Quickstart" href="quickstart.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="features">
<h1>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h1>
<p>Below is a list of main features that any EVE-powered APIs can expose. Most of
these features can be experienced live by consuming the Demo API (see
<a class="reference internal" href="index.html#demo"><em>Live demo</em></a>).</p>
<div class="section" id="emphasis-on-rest">
<h2>Emphasis on REST<a class="headerlink" href="#emphasis-on-rest" title="Permalink to this headline">¶</a></h2>
<p>The Eve project aims to provide the best possible REST-compliant API
implementation. Fundamental <a class="reference external" href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> principles like <em>separation of concerns</em>,
<em>stateless and layered system</em>, <em>cacheability</em>, <em>uniform interface</em> have been
kept into consideration while designing the core API.</p>
</div>
<div class="section" id="full-range-of-crud-operations">
<h2>Full range of CRUD operations<a class="headerlink" href="#full-range-of-crud-operations" title="Permalink to this headline">¶</a></h2>
<p>APIs can support the full range of <a class="reference external" href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> operations. Within the same API, you
can have a read-only resource accessible at one endpoint, along with a fully
editable resource at another endpoint. The following table shows Eve&#8217;s
implementation of CRUD via REST:</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="26%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action</th>
<th class="head">HTTP Verb</th>
<th class="head">Context</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Create</td>
<td>POST</td>
<td>Collection</td>
</tr>
<tr class="row-odd"><td>Create</td>
<td>PUT</td>
<td>Document</td>
</tr>
<tr class="row-even"><td>Replace</td>
<td>PUT</td>
<td>Document</td>
</tr>
<tr class="row-odd"><td>Read</td>
<td>GET, HEAD</td>
<td>Collection/Document</td>
</tr>
<tr class="row-even"><td>Update</td>
<td>PATCH</td>
<td>Document</td>
</tr>
<tr class="row-odd"><td>Delete</td>
<td>DELETE</td>
<td>Collection/Document</td>
</tr>
</tbody>
</table>
<div class="section" id="overriding-http-methods">
<h3>Overriding HTTP Methods<a class="headerlink" href="#overriding-http-methods" title="Permalink to this headline">¶</a></h3>
<p>As a fallback for the odd client not supporting any of these methods, the API
will gladly honor <tt class="docutils literal"><span class="pre">X-HTTP-Method-Override</span></tt> requests. For example a client not
supporting the <tt class="docutils literal"><span class="pre">PATCH</span></tt> method could send a <tt class="docutils literal"><span class="pre">POST</span></tt> request with
a <tt class="docutils literal"><span class="pre">X-HTTP-Method-Override:</span> <span class="pre">PATCH</span></tt> header.  The API would then perform
a <tt class="docutils literal"><span class="pre">PATCH</span></tt>, overriding the original request method.</p>
</div>
</div>
<div class="section" id="customizable-resource-endpoints">
<span id="resource-endpoints"></span><h2>Customizable resource endpoints<a class="headerlink" href="#customizable-resource-endpoints" title="Permalink to this headline">¶</a></h2>
<p>By default, Eve will make known database collections available as resource
endpoints (persistent identifiers in REST idiom). So a database <tt class="docutils literal"><span class="pre">people</span></tt>
collection will be available at the <tt class="docutils literal"><span class="pre">example.com/people</span></tt> API endpoint.  You
can customize the URIs though, so the API endpoint could become, say,
<tt class="docutils literal"><span class="pre">example.com/customers/overseas</span></tt>. Consider the following request:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>The response payload will look something like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_items&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;firstname&quot;</span><span class="o">:</span> <span class="s2">&quot;Mark&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lastname&quot;</span><span class="o">:</span> <span class="s2">&quot;Green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;born&quot;</span><span class="o">:</span> <span class="s2">&quot;Sat, 23 Feb 1985 12:00:00 GMT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;role&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">],</span>
            <span class="s2">&quot;location&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="o">:</span> <span class="s2">&quot;New York&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="o">:</span> <span class="s2">&quot;4925 Lacross Road&quot;</span><span class="p">},</span>
            <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;50bf198338345b1c604faf31&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_updated&quot;</span><span class="o">:</span> <span class="s2">&quot;Wed, 05 Dec 2012 09:53:07 GMT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_created&quot;</span><span class="o">:</span> <span class="s2">&quot;Wed, 05 Dec 2012 09:53:07 GMT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_etag&quot;</span><span class="o">:</span> <span class="s2">&quot;ec5e8200b8fa0596afe9ca71a87f23e71ca30e2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_links&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;self&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;people/50bf198338345b1c604faf31&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;person&quot;</span><span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="p">...</span>
    <span class="p">],</span>
    <span class="s2">&quot;_meta&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;max_results&quot;</span><span class="o">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="s2">&quot;total&quot;</span><span class="o">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;page&quot;</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="s2">&quot;_links&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;self&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;people&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;people&quot;</span><span class="p">},</span>
        <span class="s2">&quot;parent&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;home&quot;</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">_items</span></tt> list contains the requested data. Along with its own fields,
each item provides some important, additional fields:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">_created</span></tt></td>
<td>item creation date.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">_updated</span></tt></td>
<td>item last updated on.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">_etag</span></tt></td>
<td>ETag, to be used for concurrency control and conditional requests.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">_id</span></tt></td>
<td>unique item key, also needed to access the individual item endpoint.</td>
</tr>
</tbody>
</table>
<p>These additional fields are automatically handled by the API (clients don&#8217;t
need to provide them when adding/editing resources).</p>
<p>The <tt class="docutils literal"><span class="pre">_meta</span></tt> field provides pagination data and will only be there if
<a class="reference internal" href="#pagination"><em>Pagination</em></a> has been enabled (it is by default) and there is at least one
document being returned. The <tt class="docutils literal"><span class="pre">_links</span></tt> list provides <a class="reference external" href="http://en.wikipedia.org/wiki/HATEOAS">HATEOAS</a> directives.</p>
<div class="section" id="sub-resources">
<span id="subresources"></span><h3>Sub Resources<a class="headerlink" href="#sub-resources" title="Permalink to this headline">¶</a></h3>
<p>Endpoints support sub-resources so you could have something like:
<tt class="docutils literal"><span class="pre">people/&lt;contact_id&gt;/invoices</span></tt>. When setting the <tt class="docutils literal"><span class="pre">url</span></tt> rule for such an
endpoint you would use a regex and assign a field name to it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">invoices</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;people/&lt;regex(&quot;[a-f0-9]{24}&quot;):contact_id&gt;/invoices&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Then, a GET to the following endpoint:</p>
<div class="highlight-python"><div class="highlight"><pre>people/51f63e0838345b6dcd7eabff/invoices
</pre></div>
</div>
<p>would cause the underlying database to be queried like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;contact_id&#39;</span><span class="p">:</span> <span class="s">&#39;51f63e0838345b6dcd7eabff&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>And this one:</p>
<div class="highlight-python"><div class="highlight"><pre>people/51f63e0838345b6dcd7eabff/invoices?where={&quot;number&quot;: 10}
</pre></div>
</div>
<p>would be queried like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;contact_id&#39;</span><span class="p">:</span> <span class="s">&#39;51f63e0838345b6dcd7eabff&#39;</span><span class="p">,</span> <span class="s">&quot;number&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</pre></div>
</div>
<p>Please note that when designing your API, most of the time you can get away
without resorting to sub-resources. In the example above the same result would
be achieved by simply exposing an <tt class="docutils literal"><span class="pre">invoices</span></tt> endpoint that clients could query
this way:</p>
<div class="highlight-python"><div class="highlight"><pre>invoices?where={&quot;contact_id&quot;: 51f63e0838345b6dcd7eabff}
</pre></div>
</div>
<p>or</p>
<div class="highlight-python"><div class="highlight"><pre>invoices?where={&quot;contact_id&quot;: 51f63e0838345b6dcd7eabff, &quot;number&quot;: 10}
</pre></div>
</div>
<p>It&#8217;s mostly a design choice, but keep in mind that when it comes to enabling
individual document endpoints you might incur performance hits. This
otherwise legit GET request:</p>
<div class="highlight-python"><div class="highlight"><pre>people/&lt;contact_id&gt;/invoices/&lt;invoice_id&gt;
</pre></div>
</div>
<p>would cause a two fields lookup on the database. This is not ideal and also not
really needed, as <tt class="docutils literal"><span class="pre">&lt;invoice_id&gt;</span></tt> is a unique field. By contrast, if you had
a simple resource endpoint the document lookup would happen on a single field:</p>
<div class="highlight-python"><div class="highlight"><pre>invoices/&lt;invoice_id&gt;
</pre></div>
</div>
<p>Endpoints that supports sub-resources will have a specific behavior on
<tt class="docutils literal"><span class="pre">DELETE</span></tt> operations. A <tt class="docutils literal"><span class="pre">DELETE</span></tt> to the following endpoint:</p>
<div class="highlight-python"><div class="highlight"><pre>people/51f63e0838345b6dcd7eabff/invoices
</pre></div>
</div>
<p>would cause the deletion of all the documents that match follow query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;contact_id&#39;</span><span class="p">:</span> <span class="s">&#39;51f63e0838345b6dcd7eabff&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Therefore, for sub-resource endpoints, only the documents satisfying the
endpoint semantic will be deleted. This differs from the standard behavior,
whereas a delete operation on a collection enpoint will cause the deletion of
all the documents in the collection.</p>
<p>Another example. A <tt class="docutils literal"><span class="pre">DELETE</span></tt> to the following item endpoint:</p>
<div class="highlight-python"><div class="highlight"><pre>people/51f63e0838345b6dcd7eabff/invoices/1
</pre></div>
</div>
<p>would cause the deletion all the documents matched by the follow query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;contact_id&#39;</span><span class="p">:</span> <span class="s">&#39;51f63e0838345b6dcd7eabff&#39;</span><span class="p">,</span> <span class="s">&quot;&lt;invoice_id&gt;&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>This behaviour enables support for typical tree structures, where the id of the
resource alone is not necessarily a primary key by itself.</p>
</div>
</div>
<div class="section" id="customizable-multiple-item-endpoints">
<span id="custom-item-endpoints"></span><h2>Customizable, multiple item endpoints<a class="headerlink" href="#customizable-multiple-item-endpoints" title="Permalink to this headline">¶</a></h2>
<p>Resources can or cannot expose individual item endpoints. API consumers could
get access to <tt class="docutils literal"><span class="pre">people</span></tt>, <tt class="docutils literal"><span class="pre">people/&lt;ObjectId&gt;</span></tt> and <tt class="docutils literal"><span class="pre">people/Doe</span></tt>,
but only to <tt class="docutils literal"><span class="pre">/works</span></tt>.  When you do grant access to item endpoints, you can
define up to two lookups, both defined with regexes. The first will be the
primary endpoint and will match your database primary key structure (i.e., an
<tt class="docutils literal"><span class="pre">ObjectId</span></tt> in a MongoDB database).</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people/521d6840c437dc0002d1203c
<span class="go">HTTP/1.1 200 OK</span>
<span class="go">Etag: 28995829ee85d69c4c18d597a0f68ae606a266cc</span>
<span class="go">Last-Modified: Wed, 21 Nov 2012 16:04:56 GMT</span>
<span class="go">...</span>
</pre></div>
</div>
<p>The second, which is optional and read-only, will match a field with unique values since Eve
will retrieve only the first match anyway.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people/Doe
<span class="go">HTTP/1.1 200 OK</span>
<span class="go">Etag: 28995829ee85d69c4c18d597a0f68ae606a266cc</span>
<span class="go">Last-Modified: Wed, 21 Nov 2012 16:04:56 GMT</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Since we are accessing the same item, in both cases the response payload will
look something like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;firstname&quot;</span><span class="o">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lastname&quot;</span><span class="o">:</span> <span class="s2">&quot;Doe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;born&quot;</span><span class="o">:</span> <span class="s2">&quot;Thu, 27 Aug 1970 14:37:13 GMT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;role&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">],</span>
    <span class="s2">&quot;location&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="o">:</span> <span class="s2">&quot;Auburn&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="o">:</span> <span class="s2">&quot;422 South Gay Street&quot;</span><span class="p">},</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;50acfba938345b0978fccad7&quot;</span>
    <span class="s2">&quot;_updated&quot;</span><span class="o">:</span> <span class="s2">&quot;Wed, 21 Nov 2012 16:04:56 GMT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_created&quot;</span><span class="o">:</span> <span class="s2">&quot;Wed, 21 Nov 2012 16:04:56 GMT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_etag&quot;</span><span class="o">:</span> <span class="s2">&quot;28995829ee85d69c4c18d597a0f68ae606a266cc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_links&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;self&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;people/50acfba938345b0978fccad7&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;person&quot;</span><span class="p">},</span>
        <span class="s2">&quot;parent&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;home&quot;</span><span class="p">},</span>
        <span class="s2">&quot;collection&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;people&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;people&quot;</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see, item endpoints provide their own <a class="reference external" href="http://en.wikipedia.org/wiki/HATEOAS">HATEOAS</a> directives.</p>
<div class="admonition-please-note admonition">
<p class="first admonition-title">Please Note</p>
<p>According to REST principles resource items should only have one unique
identifier. Eve abides by providing one default endpoint per item. Adding
a secondary endpoint is a decision that should be pondered carefully.</p>
<p class="last">Consider our example above. Even without the <tt class="docutils literal"><span class="pre">people/&lt;lastname&gt;</span></tt>
endpoint, a client could always retrieve a person by querying the resource
endpoint by last name: <tt class="docutils literal"><span class="pre">people/?where={&quot;lastname&quot;:</span> <span class="pre">&quot;Doe&quot;}</span></tt>. Actually the
whole example is fubar, as there could be multiple people sharing the same
last name, but you get the idea.</p>
</div>
</div>
<div class="section" id="filtering">
<span id="filters"></span><h2>Filtering<a class="headerlink" href="#filtering" title="Permalink to this headline">¶</a></h2>
<p>Resource endpoints allow consumers to retrieve multiple documents. Query
strings are supported, allowing for filtering and sorting. Both native Mongo
queries and Python conditional expressions are supported.</p>
<p>Here we are asking for all documents where <tt class="docutils literal"><span class="pre">lastname</span></tt> value is <tt class="docutils literal"><span class="pre">Doe</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>http://eve-demo.herokuapp.com/people?where={&quot;lastname&quot;: &quot;Doe&quot;}
</pre></div>
</div>
<p>With <tt class="docutils literal"><span class="pre">curl</span></tt> you would go like this:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i -g http://eve-demo.herokuapp.com/people?where<span class="o">={</span>%22lastname%22:%20%22Doe%22<span class="o">}</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>Filtering on embedded document fields is possible:</p>
<div class="highlight-python"><div class="highlight"><pre>http://eve-demo.herokuapp.com/people?where={&quot;location.city&quot;: &quot;San Francisco&quot;}
</pre></div>
</div>
<p>Date fields are also easy to query on:</p>
<div class="highlight-python"><div class="highlight"><pre>http://eve-demo.herokuapp.com/people?where={&quot;born&quot;: {&quot;$gte&quot;:&quot;Wed, 25 Feb 1987 17:00:00 GMT&quot;}}
</pre></div>
</div>
<p>Date values should conform to RFC1123. Should you need a different format, you can change the <tt class="docutils literal"><span class="pre">DATE_FORMAT</span></tt> setting.</p>
<p>In general you will find that most <a class="reference external" href="https://docs.mongodb.com/v3.2/reference/operator/query/">MongoDB queries</a> &#8220;just work&#8221;. Should you
need it, <tt class="docutils literal"><span class="pre">MONGO_QUERY_BLACKLIST</span></tt> allows you to blacklist unwanted operators.</p>
<p>Native Python syntax works like this:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people?where<span class="o">=</span><span class="nv">lastname</span><span class="o">==</span><span class="s2">&quot;Doe&quot;</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>Both syntaxes allow for conditional and logical And/Or operators, however
nested and combined.</p>
<p>Filters are enabled by default on all document fields. However, the API
maintainer can choose to disable them all and/or whitelist allowed ones (see
<tt class="docutils literal"><span class="pre">ALLOWED_FILTERS</span></tt> in <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a>). If scraping, or fear of DB DoS attacks
by querying on non-indexed fields is a concern, then whitelisting allowed
filters is the way to go.</p>
<p>You also have the option to validate the incoming filters against the resource&#8217;s
schema and refuse to apply the filtering if any filters are invalid, by using the
<tt class="docutils literal"><span class="pre">VALIDATE_FILTERING</span></tt> system setting (see <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a>)</p>
</div>
<div class="section" id="pretty-printing">
<h2>Pretty Printing<a class="headerlink" href="#pretty-printing" title="Permalink to this headline">¶</a></h2>
<p>You can pretty print the response by specifying a query parameter named
<tt class="docutils literal"><span class="pre">pretty</span></tt>:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people?pretty
<span class="go">HTTP/1.1 200 OK</span>

<span class="go">{</span>
<span class="go">    &quot;_items&quot;: [</span>
<span class="go">        {</span>
<span class="go">            &quot;_updated&quot;: &quot;Tue, 19 Apr 2016 08:19:00 GMT&quot;,</span>
<span class="go">            &quot;firstname&quot;: &quot;John&quot;,</span>
<span class="go">            &quot;lastname&quot;: &quot;Doe&quot;,</span>
<span class="go">            &quot;born&quot;: &quot;Thu, 27 Aug 1970 14:37:13 GMT&quot;,</span>
<span class="go">            &quot;role&quot;: [</span>
<span class="go">                &quot;author&quot;</span>
<span class="go">            ],</span>
<span class="go">            &quot;location&quot;: {</span>
<span class="go">                &quot;city&quot;: &quot;Auburn&quot;,</span>
<span class="go">                &quot;address&quot;: &quot;422 South Gay Street&quot;</span>
<span class="go">            },</span>
<span class="go">            &quot;_links&quot;: {</span>
<span class="go">                &quot;self&quot;: {</span>
<span class="go">                    &quot;href&quot;: &quot;people/5715e9f438345b3510d27eb8&quot;,</span>
<span class="go">                    &quot;title&quot;: &quot;person&quot;</span>
<span class="go">                }</span>
<span class="go">            },</span>
<span class="go">            &quot;_created&quot;: &quot;Tue, 19 Apr 2016 08:19:00 GMT&quot;,</span>
<span class="go">            &quot;_id&quot;: &quot;5715e9f438345b3510d27eb8&quot;,</span>
<span class="go">            &quot;_etag&quot;: &quot;86dc6b45fe7e2f41f1ca53a0e8fda81224229799&quot;</span>
<span class="go">        },</span>
<span class="go">        ...</span>
<span class="go">    ]</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<div class="section" id="sorting">
<h2>Sorting<a class="headerlink" href="#sorting" title="Permalink to this headline">¶</a></h2>
<p>Sorting is supported as well:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people?sort<span class="o">=</span>city,-lastname
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>Would return documents sorted by city and then by lastname (descending). As you
can see you simply prepend a minus to the field name if you need the sort order
to be reversed for a field.</p>
<p>The MongoDB data layer also supports native MongoDB syntax:</p>
<div class="highlight-python"><div class="highlight"><pre>http://eve-demo.herokuapp.com/people?sort=[(&quot;lastname&quot;, -1)]
</pre></div>
</div>
<p>which translates to the following <tt class="docutils literal"><span class="pre">curl</span></tt> request:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people?sort<span class="o">=[(</span>%22lastname%22,%20-1<span class="o">)]</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>Would return documents sorted by lastname in descending order.</p>
<p>Sorting is enabled by default and can be disabled both globally and/or at
resource level (see <tt class="docutils literal"><span class="pre">SORTING</span></tt> in <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a> and <tt class="docutils literal"><span class="pre">sorting</span></tt> in
<a class="reference internal" href="config.html#domain"><em>Domain Configuration</em></a>). It is also possible to set the default sort at every API
endpoints (see <tt class="docutils literal"><span class="pre">default_sort</span></tt> in <a class="reference internal" href="config.html#domain"><em>Domain Configuration</em></a>).</p>
<div class="admonition-please-note admonition">
<p class="first admonition-title">Please note</p>
<p class="last">Always use double quotes to wrap field names and values. Using single
quotes will result in <tt class="docutils literal"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></tt> responses.</p>
</div>
</div>
<div class="section" id="pagination">
<span id="id1"></span><h2>Pagination<a class="headerlink" href="#pagination" title="Permalink to this headline">¶</a></h2>
<p>Resource pagination is enabled by default in order to improve performance and
preserve bandwidth. When a consumer requests a resource, the first N items
matching the query are served, and links to subsequent/previous pages are
provided with the response. Default and maximum page size is customizable, and
consumers can request specific pages via the query string:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people?max_results<span class="o">=</span>20<span class="p">&amp;</span><span class="nv">page</span><span class="o">=</span>2
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>Of course you can mix all the available query parameters:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people?where<span class="o">={</span><span class="s2">&quot;lastname&quot;</span>: <span class="s2">&quot;Doe&quot;</span><span class="o">}</span><span class="p">&amp;</span><span class="nv">sort</span><span class="o">=[(</span><span class="s2">&quot;firstname&quot;</span>, 1<span class="o">)]</span><span class="p">&amp;</span><span class="nv">page</span><span class="o">=</span>5
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>Pagination can be disabled. Please note that, for clarity, the above example is
not properly escaped. If using <tt class="docutils literal"><span class="pre">curl</span></tt>, refer to the examples provided in
<a class="reference internal" href="#filters"><em>Filtering</em></a>.</p>
</div>
<div class="section" id="hateoas">
<span id="hateoas-feature"></span><h2>HATEOAS<a class="headerlink" href="#hateoas" title="Permalink to this headline">¶</a></h2>
<p><em>Hypermedia as the Engine of Application State</em> (<a class="reference external" href="http://en.wikipedia.org/wiki/HATEOAS">HATEOAS</a>) is enabled by
default. Each GET response includes a <tt class="docutils literal"><span class="pre">_links</span></tt> section. Links provide details
on their <tt class="docutils literal"><span class="pre">relation</span></tt> relative to the resource being accessed, and a <tt class="docutils literal"><span class="pre">title</span></tt>.
Relations and titles can then be used by clients to dynamically updated their
UI, or to navigate the API without knowing its structure beforehand. An example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;_links&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;self&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;href&quot;</span><span class="p">:</span> <span class="s">&quot;people&quot;</span><span class="p">,</span>
            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;people&quot;</span>
        <span class="p">},</span>
        <span class="s">&quot;parent&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;href&quot;</span><span class="p">:</span> <span class="s">&quot;/&quot;</span><span class="p">,</span>
            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;home&quot;</span>
        <span class="p">},</span>
        <span class="s">&quot;next&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;href&quot;</span><span class="p">:</span> <span class="s">&quot;people?page=2&quot;</span><span class="p">,</span>
            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;next page&quot;</span>
        <span class="p">},</span>
        <span class="s">&quot;last&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;href&quot;</span><span class="p">:</span> <span class="s">&quot;people?page=10&quot;</span><span class="p">,</span>
            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;last page&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A GET request to the API home page (the API entry point) will be served with
a list of links to accessible resources. From there, any client could navigate
the API just by following the links provided with every response.</p>
<p>HATEOAS links are always relative to the API entry point, so if your API home
is at <tt class="docutils literal"><span class="pre">examples.com/api/v1</span></tt>, the <tt class="docutils literal"><span class="pre">self</span></tt> link in the above example would
mean that the <em>people</em> endpoint is located at <tt class="docutils literal"><span class="pre">examples.com/api/v1/people</span></tt>.</p>
<p>Please note that <tt class="docutils literal"><span class="pre">next</span></tt>, <tt class="docutils literal"><span class="pre">previous</span></tt> and <tt class="docutils literal"><span class="pre">last</span></tt> items will only be
included when appropriate.</p>
<div class="section" id="disabling-hateoas">
<h3>Disabling HATEOAS<a class="headerlink" href="#disabling-hateoas" title="Permalink to this headline">¶</a></h3>
<p>HATEOAS can be disabled both at the API and/or resource level. Why would you
want to turn HATEOAS off? Well, if you know that your client application is not
going to use the feature, then you might want to save on both bandwidth and
performance.</p>
</div>
</div>
<div class="section" id="rendering">
<span id="id2"></span><h2>Rendering<a class="headerlink" href="#rendering" title="Permalink to this headline">¶</a></h2>
<p>Eve responses are automatically rendered as JSON (the default) or XML,
depending on the request <tt class="docutils literal"><span class="pre">Accept</span></tt> header. Inbound documents (for inserts and
edits) are in JSON format.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -H <span class="s2">&quot;Accept: application/xml&quot;</span> -i http://eve-demo.herokuapp.com
<span class="go">HTTP/1.1 200 OK</span>
<span class="go">Content-Type: application/xml; charset=utf-8</span>
<span class="go">...</span>
</pre></div>
</div>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;resource&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;child&quot;</span> <span class="na">href=</span><span class="s">&quot;people&quot;</span> <span class="na">title=</span><span class="s">&quot;people&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;child&quot;</span> <span class="na">href=</span><span class="s">&quot;works&quot;</span> <span class="na">title=</span><span class="s">&quot;works&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resource&gt;</span>
</pre></div>
</div>
<p>Default renderers might be changed by editing <tt class="docutils literal"><span class="pre">RENDERERS</span></tt> value in the settings file.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">RENDERERS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;eve.render.JSONRenderer&#39;</span><span class="p">,</span>
    <span class="s">&#39;eve.render.XMLRenderer&#39;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>You can create your own renderer by subclassing <tt class="docutils literal"><span class="pre">eve.render.Renderer</span></tt>. Each
renderer should set valid <tt class="docutils literal"><span class="pre">mime</span></tt> attr and have <tt class="docutils literal"><span class="pre">.render()</span></tt> method implemented.
Please note that at least one renderer must always be enabled.</p>
</div>
<div class="section" id="conditional-requests">
<span id="id3"></span><h2>Conditional Requests<a class="headerlink" href="#conditional-requests" title="Permalink to this headline">¶</a></h2>
<p>Each resource representation provides information on the last time it was
updated (<tt class="docutils literal"><span class="pre">Last-Modified</span></tt>), along with an hash value computed on the
representation itself (<tt class="docutils literal"><span class="pre">ETag</span></tt>). These headers allow clients to perform
conditional requests by using the <tt class="docutils literal"><span class="pre">If-Modified-Since</span></tt> header:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -H <span class="s2">&quot;If-Modified-Since: Wed, 05 Dec 2012 09:53:07 GMT&quot;</span> -i http://eve-demo.herokuapp.com/people/521d6840c437dc0002d1203c
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>or the <tt class="docutils literal"><span class="pre">If-None-Match</span></tt> header:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -H <span class="s2">&quot;If-None-Match: 1234567890123456789012345678901234567890&quot;</span> -i http://eve-demo.herokuapp.com/people/521d6840c437dc0002d1203c
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
</div>
<div class="section" id="data-integrity-and-concurrency-control">
<span id="concurrency"></span><h2>Data Integrity and Concurrency Control<a class="headerlink" href="#data-integrity-and-concurrency-control" title="Permalink to this headline">¶</a></h2>
<p>API responses include a <tt class="docutils literal"><span class="pre">ETag</span></tt> header which also allows for proper
concurrency control. An <tt class="docutils literal"><span class="pre">ETag</span></tt> is a hash value representing the current state
of the resource on the server. Consumers are not allowed to edit (<tt class="docutils literal"><span class="pre">PATCH</span></tt> or
<tt class="docutils literal"><span class="pre">PUT</span></tt>) or delete (<tt class="docutils literal"><span class="pre">DELETE</span></tt>) a resource unless they provide an up-to-date
<tt class="docutils literal"><span class="pre">ETag</span></tt> for the resource they are attempting to edit. This prevents
overwriting items with obsolete versions.</p>
<p>Consider the following workflow:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PATCH -i http://eve-demo.herokuapp.com/people/521d6840c437dc0002d1203c -d <span class="s1">&#39;{&quot;firstname&quot;: &quot;ronald&quot;}&#39;</span>
<span class="go">HTTP/1.1 428 PRECONDITION REQUIRED</span>
</pre></div>
</div>
<p>We attempted an edit (<tt class="docutils literal"><span class="pre">PATCH</span></tt>), but we did not provide an <tt class="docutils literal"><span class="pre">ETag</span></tt> for the
item so we got a <tt class="docutils literal"><span class="pre">428</span> <span class="pre">PRECONDITION</span> <span class="pre">REQUIRED</span></tt> back. Let&#8217;s try again:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -H <span class="s2">&quot;If-Match: 1234567890123456789012345678901234567890&quot;</span> -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PATCH -i http://eve-demo.herokuapp.com/people/521d6840c437dc0002d1203c -d <span class="s1">&#39;{&quot;firstname&quot;: &quot;ronald&quot;}&#39;</span>
<span class="go">HTTP/1.1 412 PRECONDITION FAILED</span>
</pre></div>
</div>
<p>What went wrong this time? We provided the mandatory <tt class="docutils literal"><span class="pre">If-Match</span></tt> header, but
it&#8217;s value did not match the <tt class="docutils literal"><span class="pre">ETag</span></tt> computed on the representation of the item
currently stored on the server, so we got a <tt class="docutils literal"><span class="pre">412</span> <span class="pre">PRECONDITION</span> <span class="pre">FAILED</span></tt>. Again!</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -H <span class="s2">&quot;If-Match: 80b81f314712932a4d4ea75ab0b76a4eea613012&quot;</span> -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PATCH -i http://eve-demo.herokuapp.com/people/50adfa4038345b1049c88a37 -d <span class="s1">&#39;{&quot;firstname&quot;: &quot;ronald&quot;}&#39;</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>Finally! And the response payload looks something like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_status&quot;</span><span class="o">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_updated&quot;</span><span class="o">:</span> <span class="s2">&quot;Fri, 23 Nov 2012 08:11:19 GMT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;50adfa4038345b1049c88a37&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_etag&quot;</span><span class="o">:</span> <span class="s2">&quot;372fbbebf54dfe61742556f17a8461ca9a6f5a11&quot;</span>
    <span class="s2">&quot;_links&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="o">:</span> <span class="s2">&quot;...&quot;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This time we got our patch in, and the server returned the new <tt class="docutils literal"><span class="pre">ETag</span></tt>.  We
also get the new <tt class="docutils literal"><span class="pre">_updated</span></tt> value, which eventually will allow us to perform
subsequent <a class="reference internal" href="#id3">conditional requests</a>.</p>
<p>Concurrency control applies to all edition methods: <tt class="docutils literal"><span class="pre">PATCH</span></tt> (edit), <tt class="docutils literal"><span class="pre">PUT</span></tt>
(replace), <tt class="docutils literal"><span class="pre">DELETE</span></tt> (delete).</p>
<div class="section" id="disabling-concurrency-control">
<h3>Disabling concurrency control<a class="headerlink" href="#disabling-concurrency-control" title="Permalink to this headline">¶</a></h3>
<p>If your use case requires, you can opt to completely disable concurrency
control. ETag match checks can be disabled by setting the <tt class="docutils literal"><span class="pre">IF_MATCH</span></tt>
configuration variable to <tt class="docutils literal"><span class="pre">False</span></tt> (see <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a>). When concurrency
control is disabled no ETag is provided with responses. You should be careful
about disabling this feature, as you would effectively open your API to the
risk of older versions replacing your documents. Alternatively, ETag match
checks can be made optional by the client if <tt class="docutils literal"><span class="pre">ENFORCE_IF_MATCH</span></tt> is disabled.
When concurrenncy check enforcement is disabled, requests with the <tt class="docutils literal"><span class="pre">If-Match</span></tt>
header will be processed as conditional requests, and requests made without
the <tt class="docutils literal"><span class="pre">If-Match</span></tt> header will not be processed as conditional.</p>
</div>
</div>
<div class="section" id="bulk-inserts">
<span id="bulk-insert"></span><h2>Bulk Inserts<a class="headerlink" href="#bulk-inserts" title="Permalink to this headline">¶</a></h2>
<p>A client may submit a single document for insertion:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -d <span class="s1">&#39;{&quot;firstname&quot;: &quot;barack&quot;, &quot;lastname&quot;: &quot;obama&quot;}&#39;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://eve-demo.herokuapp.com/people
<span class="go">HTTP/1.1 201 OK</span>
</pre></div>
</div>
<p>In this case the response payload will just contain the relevant document
metadata:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_status&quot;</span><span class="o">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_updated&quot;</span><span class="o">:</span> <span class="s2">&quot;Thu, 22 Nov 2012 15:22:27 GMT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;50ae43339fa12500024def5b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_etag&quot;</span><span class="o">:</span> <span class="s2">&quot;749093d334ebd05cf7f2b7dbfb7868605578db2c&quot;</span>
    <span class="s2">&quot;_links&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;people/50ae43339fa12500024def5b&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;person&quot;</span><span class="p">}}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When a <tt class="docutils literal"><span class="pre">201</span> <span class="pre">Created</span></tt> is returned following a POST request, the <tt class="docutils literal"><span class="pre">Location</span></tt>
header is also included with the response. Its value is the URI to the new
document.</p>
<p>In order to reduce the number of loopbacks, a client might also submit
multiple documents with a single request. All it needs to do is enclose the
documents in a JSON list:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -d <span class="s1">&#39;[{&quot;firstname&quot;: &quot;barack&quot;, &quot;lastname&quot;: &quot;obama&quot;}, {&quot;firstname&quot;: &quot;mitt&quot;, &quot;lastname&quot;: &quot;romney&quot;}]&#39;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://eve-demo.herokuapp.com/people
<span class="go">HTTP/1.1 201 OK</span>
</pre></div>
</div>
<p>The response will be a list itself, with the state of each document:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_status&quot;</span><span class="o">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_items&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;_status&quot;</span><span class="o">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_updated&quot;</span><span class="o">:</span> <span class="s2">&quot;Thu, 22 Nov 2012 15:22:27 GMT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;50ae43339fa12500024def5b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_etag&quot;</span><span class="o">:</span> <span class="s2">&quot;749093d334ebd05cf7f2b7dbfb7868605578db2c&quot;</span>
            <span class="s2">&quot;_links&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;people/50ae43339fa12500024def5b&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;person&quot;</span><span class="p">}}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;_status&quot;</span><span class="o">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_updated&quot;</span><span class="o">:</span> <span class="s2">&quot;Thu, 22 Nov 2012 15:22:27 GMT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;50ae43339fa12500024def5c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_etag&quot;</span><span class="o">:</span> <span class="s2">&quot;62d356f623c7d9dc864ffa5facc47dced4ba6907&quot;</span>
            <span class="s2">&quot;_links&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;href&quot;</span><span class="o">:</span> <span class="s2">&quot;people/50ae43339fa12500024def5c&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;person&quot;</span><span class="p">}}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When multiple documents are submitted the API takes advantage of MongoDB <em>bulk
insert</em> capabilities which means that not only there&#8217;s just one request
traveling from the client to the remote API, but also that a single loopback is
performed between the API server and the database.</p>
<p>In case of successful multiple inserts, keep in mind that the <tt class="docutils literal"><span class="pre">Location</span></tt>
header only returns the URI of the first created document.</p>
</div>
<div class="section" id="data-validation">
<h2>Data Validation<a class="headerlink" href="#data-validation" title="Permalink to this headline">¶</a></h2>
<p>Data validation is provided out-of-the-box. Your configuration includes
a schema definition for every resource managed by the API. Data sent to the API
to be inserted/updated will be validated against the schema, and a resource
will only be updated if validation passes.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -d <span class="s1">&#39;[{&quot;firstname&quot;: &quot;bill&quot;, &quot;lastname&quot;: &quot;clinton&quot;}, {&quot;firstname&quot;: &quot;mitt&quot;, &quot;lastname&quot;: &quot;romney&quot;}]&#39;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://eve-demo.herokuapp.com/people
<span class="go">HTTP/1.1 201 OK</span>
</pre></div>
</div>
<p>The response will contain a success/error state for each item provided in the
request:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_status&quot;</span><span class="o">:</span> <span class="s2">&quot;ERR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_error&quot;</span><span class="o">:</span> <span class="s2">&quot;Some documents contains errors&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_items&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;_status&quot;</span><span class="o">:</span> <span class="s2">&quot;ERR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_issues&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;lastname&quot;</span><span class="o">:</span> <span class="s2">&quot;value &#39;clinton&#39; not unique&quot;</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;_status&quot;</span><span class="o">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
<p>In the example above, the first document did not validate so the whole request
has been rejected.</p>
<p>When all documents pass validation and are inserted correctly the response
status is <tt class="docutils literal"><span class="pre">201</span> <span class="pre">Created</span></tt>. If any document fails validation the response status
is <tt class="docutils literal"><span class="pre">422</span> <span class="pre">Unprocessable</span> <span class="pre">Entity</span></tt>, or any other error code defined by
<tt class="docutils literal"><span class="pre">VALIDATION_ERROR_STATUS</span></tt> configuration.</p>
<p>For more information see <a class="reference internal" href="validation.html#validation"><em>Data Validation</em></a>.</p>
</div>
<div class="section" id="extensible-data-validation">
<h2>Extensible Data Validation<a class="headerlink" href="#extensible-data-validation" title="Permalink to this headline">¶</a></h2>
<p>Data validation is based on the <a class="reference external" href="https://github.com/pyeve/cerberus">Cerberus</a> validation system and therefore it is
extensible, so you can adapt it to your specific use case. Say that your API can
only accept odd numbers for a certain field value; you can extend the
validation class to validate that. Or say you want to make sure that a VAT
field actually matches your own country VAT algorithm; you can do that too. As
a matter of fact, Eve&#8217;s MongoDB data-layer itself extends Cerberus
validation by implementing the <tt class="docutils literal"><span class="pre">unique</span></tt> schema field constraint. For more
information see <a class="reference internal" href="validation.html#validation"><em>Data Validation</em></a>.</p>
</div>
<div class="section" id="resource-level-cache-control">
<span id="cache-control"></span><h2>Resource-level Cache Control<a class="headerlink" href="#resource-level-cache-control" title="Permalink to this headline">¶</a></h2>
<p>You can set global and individual cache-control directives for each resource.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com
<span class="go">HTTP/1.1 200 OK</span>
<span class="go">Content-Type: application/json</span>
<span class="go">Content-Length: 131</span>
<span class="go">Cache-Control: max-age=20</span>
<span class="go">Expires: Tue, 22 Jan 2013 09:34:34 GMT</span>
<span class="go">Server: Eve/0.0.3 Werkzeug/0.8.3 Python/2.7.3</span>
<span class="go">Date: Tue, 22 Jan 2013 09:34:14 GMT</span>
</pre></div>
</div>
<p>The response above includes both <tt class="docutils literal"><span class="pre">Cache-Control</span></tt> and <tt class="docutils literal"><span class="pre">Expires</span></tt> headers.
These will minimize load on the server since cache-enabled consumers will
perform resource-intensive request only when really needed.</p>
</div>
<div class="section" id="api-versioning">
<h2>API Versioning<a class="headerlink" href="#api-versioning" title="Permalink to this headline">¶</a></h2>
<p>I&#8217;m not too fond of API versioning. I believe that clients should be
intelligent enough to deal with API updates transparently, especially since
Eve-powered API support <a class="reference external" href="http://en.wikipedia.org/wiki/HATEOAS">HATEOAS</a>. When versioning is a necessity, different API
versions should be isolated instances since so many things could be different
between versions: caching, URIs, schemas, validation, and so on. URI versioning
(<a class="reference external" href="http://api.example.com/v1/">http://api.example.com/v1/</a>...) is supported.</p>
</div>
<div class="section" id="document-versioning">
<span id="id4"></span><h2>Document Versioning<a class="headerlink" href="#document-versioning" title="Permalink to this headline">¶</a></h2>
<p>Eve supports automatic version control of documents. By default, this setting
is turned off, but it can be turned globally or configured individually for
each resource. When enabled, Eve begins automatically tracking changes to
documents and adds the fields <tt class="docutils literal"><span class="pre">_version</span></tt> and <tt class="docutils literal"><span class="pre">_latest_version</span></tt> when
retrieving documents.</p>
<p>Behind the scenes, Eve stores document versions in shadow collections that
parallels the collection of each primary resource that Eve defines. New
document versions are automatically added to this collection during normal
POST, PUT, and PATCH operations. A special new query parameter is available
when GETing an item that provides access to the document versions. Access a
specific version with <tt class="docutils literal"><span class="pre">?version=VERSION</span></tt>, access all versions with
<tt class="docutils literal"><span class="pre">?version=all</span></tt>, and access diffs of all versions with <tt class="docutils literal"><span class="pre">?version=diffs</span></tt>.
Collection query features like projections, pagination, and sorting work with
<tt class="docutils literal"><span class="pre">all</span></tt> and <tt class="docutils literal"><span class="pre">diff</span></tt> except for sorting which does not work on <tt class="docutils literal"><span class="pre">diff</span></tt>.</p>
<p>It is important to note that there are a few non-standard scenarios which could
produce unexpected results when versioning is turned on. In particular, document
history will not be saved when modifying collections outside of the Eve
generated API. Also, if at anytime the <tt class="docutils literal"><span class="pre">VERSION</span></tt> field gets removed from the
primary document (which cannot happen through the API when versioning is turned
on), a subsequent write will re-initialize the <tt class="docutils literal"><span class="pre">VERSION</span></tt> number with
<tt class="docutils literal"><span class="pre">VERSION</span></tt> = 1. At this time there will be multiple versions of the document
with the same version number. In normal practice, <tt class="docutils literal"><span class="pre">VERSIONING</span></tt> can be enable
without worry for any new collection or even an existing collection which has
not previously had versioning enabled.</p>
<p>Additionally, there are caching corner cases unique to document versions. A
specific document version includes the <tt class="docutils literal"><span class="pre">_latest_version</span></tt> field, the value of
which will change when a new document version is created. To account for this,
Eve determines the time <tt class="docutils literal"><span class="pre">_latest_version</span></tt> changed (the timestamp of the last
update to the primary document) and uses that value to populate the
<tt class="docutils literal"><span class="pre">Last-Modified</span></tt> header and check the <tt class="docutils literal"><span class="pre">If-Modified-Since</span></tt> conditional cache
validator of specific document version queries. Note that this will be
different from the timestamp in the version&#8217;s last updated field. The etag for
a document version does not change when <tt class="docutils literal"><span class="pre">_latest_version</span></tt> changes, however.
This results in two corner cases. First, because Eve cannot determine if the
client&#8217;s <tt class="docutils literal"><span class="pre">_latest_version</span></tt> is up to date from an ETag alone, a query using
only <tt class="docutils literal"><span class="pre">If-None-Match</span></tt> for cache validation of old document versions will always
have its cache invalidated. Second, a version fetched and cached in the same
second that multiple new versions are created can receive incorrect
<tt class="docutils literal"><span class="pre">Not</span> <span class="pre">Modified</span></tt> responses on ensuing <tt class="docutils literal"><span class="pre">GET</span></tt> queries due to <tt class="docutils literal"><span class="pre">Last-Modified</span></tt>
values having a resolution of one second and the static etag values not
providing indication of the changes. These are both highly unlikely scenarios,
but an application expecting multiple edits per second should account for the
possibility of holing stale <tt class="docutils literal"><span class="pre">_latest_version</span></tt> data.</p>
<p>For more information see and <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a> and <a class="reference internal" href="config.html#domain"><em>Domain Configuration</em></a>.</p>
</div>
<div class="section" id="authentication">
<h2>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h2>
<p>Customizable Basic Authentication (RFC-2617), Token-based authentication and
HMAC-based Authentication are supported. OAuth2 can be easily integrated. You
can lockdown the whole API, or just some endpoints. You can also restrict CRUD
commands, like allowing open read-only access while restricting edits, inserts
and deletes to authorized users. Role-based access control is supported as
well. For more information see <a class="reference internal" href="authentication.html#auth"><em>Authentication and Authorization</em></a>.</p>
</div>
<div class="section" id="cors-cross-origin-resource-sharing">
<h2>CORS Cross-Origin Resource Sharing<a class="headerlink" href="#cors-cross-origin-resource-sharing" title="Permalink to this headline">¶</a></h2>
<p>Eve-powered APIs can be accessed by the JavaScript contained in web pages.
Disabled by default, <a class="reference external" href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> allows web pages to work with REST APIs, something
that is usually restricted by most browsers &#8216;same domain&#8217; security policy. The
<tt class="docutils literal"><span class="pre">X_DOMAINS</span></tt> setting allows to specify which domains are allowed to perform
CORS requests. A list of regular expressions may be defined in <tt class="docutils literal"><span class="pre">X_DOMAINS_RE</span></tt>, which is useful for websites with dynamic ranges of subdomains. Make sure to
anchor and escape the regexes properly, for example
<tt class="docutils literal"><span class="pre">X_DOMAINS_RE</span> <span class="pre">=</span> <span class="pre">['^http://sub-\d{3}\.example\.com$']</span></tt>.</p>
</div>
<div class="section" id="jsonp-support">
<h2>JSONP Support<a class="headerlink" href="#jsonp-support" title="Permalink to this headline">¶</a></h2>
<p>In general you don&#8217;t really want to add JSONP when you can enable CORS instead:</p>
<blockquote>
<div>There have been some criticisms raised about JSONP. Cross-origin resource
sharing (CORS) is a more recent method of getting data from a server in
a different domain, which addresses some of those criticisms. All modern
browsers now support CORS making it a viable cross-browser alternative (<a class="reference external" href="http://en.wikipedia.org/wiki/JSONP">source</a>.)</div></blockquote>
<p>There are circumstances however when you do need JSONP, like when you have to
support legacy software (IE6 anyone?)</p>
<p>To enable JSONP in Eve you just set
<tt class="docutils literal"><span class="pre">JSONP_ARGUMENT</span></tt>. Then, any valid request with <tt class="docutils literal"><span class="pre">JSONP_ARGUMENT</span></tt> will get
back a response wrapped with said argument value. For example if you set
<tt class="docutils literal"><span class="pre">JSON_ARGUMENT</span> <span class="pre">=</span> <span class="pre">'callback'</span></tt>:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://localhost:5000/?callback<span class="o">=</span>hello
<span class="go">hello(&lt;JSON here&gt;)</span>
</pre></div>
</div>
<p>Requests with no <tt class="docutils literal"><span class="pre">callback</span></tt> argument will be served with no JSONP.</p>
</div>
<div class="section" id="read-only-by-default">
<h2>Read-only by default<a class="headerlink" href="#read-only-by-default" title="Permalink to this headline">¶</a></h2>
<p>If all you need is a read-only API, then you can have it up and running in
a matter of minutes.</p>
</div>
<div class="section" id="default-and-nullable-values">
<h2>Default and Nullable Values<a class="headerlink" href="#default-and-nullable-values" title="Permalink to this headline">¶</a></h2>
<p>Fields can have default values and nullable types. When serving POST (create)
requests, missing fields will be assigned the configured default values. See
<tt class="docutils literal"><span class="pre">default</span></tt> and <tt class="docutils literal"><span class="pre">nullable</span></tt> keywords in <a class="reference internal" href="config.html#schema"><em>Schema Definition</em></a> for more informations.</p>
</div>
<div class="section" id="predefined-database-filters">
<h2>Predefined Database Filters<a class="headerlink" href="#predefined-database-filters" title="Permalink to this headline">¶</a></h2>
<p>Resource endpoints will only expose (and update) documents that match
a predefined filter. This allows for multiple resource endpoints to seamlessly
target the same database collection. A typical use-case would be a
hypothetical <tt class="docutils literal"><span class="pre">people</span></tt> collection on the database being used by both the
<tt class="docutils literal"><span class="pre">/admins</span></tt> and <tt class="docutils literal"><span class="pre">/users</span></tt> API endpoints.</p>
<div class="admonition-see-also admonition">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference internal" href="config.html#datasource"><em>Advanced Datasource Patterns</em></a></li>
<li><a class="reference internal" href="config.html#filter"><em>Predefined Database Filters</em></a></li>
</ul>
</div>
</div>
<div class="section" id="projections">
<span id="id5"></span><h2>Projections<a class="headerlink" href="#projections" title="Permalink to this headline">¶</a></h2>
<p>This feature allows you to create dynamic views of collections and documents,
or more precisely, to decide what fields should or should not be returned,
using a &#8216;projection&#8217;. Put another way, Projections are conditional queries
where the client dictates which fields should be returned by the API.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people?projection<span class="o">={</span><span class="s2">&quot;lastname&quot;</span>: 1, <span class="s2">&quot;born&quot;</span>: 1<span class="o">}</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>The query above will only return <em>lastname</em> and <em>born</em> out of all the fields
available in the &#8216;people&#8217; resource. You can also exclude fields:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://eve-demo.herokuapp.com/people?projection<span class="o">={</span><span class="s2">&quot;born&quot;</span>: 0<span class="o">}</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>The above will return all fields but <em>born</em>. Please note that key fields such
as ID_FIELD, DATE_CREATED, DATE_UPDATED etc.  will still be included with the
payload. Also keep in mind that some database engines, Mongo included, do not
allow for mixing of inclusive and exclusive selections.</p>
<div class="admonition-see-also admonition">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference internal" href="config.html#projection"><em>Limiting the Fieldset Exposed by the API Endpoint</em></a></li>
<li><a class="reference internal" href="#projection-filestorage"><em>Leveraging Projections to optimize the handling of media files</em></a></li>
</ul>
</div>
</div>
<div class="section" id="embedded-resource-serialization">
<span id="embedded-docs"></span><h2>Embedded Resource Serialization<a class="headerlink" href="#embedded-resource-serialization" title="Permalink to this headline">¶</a></h2>
<p>If a document field is referencing a document in another resource, clients can
request the referenced document to be embedded within the requested document.</p>
<p>Clients have the power to activate document embedding on per-request basis by
means of a query parameter. Suppose you have a <tt class="docutils literal"><span class="pre">emails</span></tt> resource configured
like this:</p>
<div class="highlight-python"><div class="highlight"><pre> <span class="n">DOMAIN</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s">&#39;emails&#39;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s">&#39;schema&#39;</span><span class="p">:</span> <span class="p">{</span>
             <span class="s">&#39;author&#39;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;objectid&#39;</span><span class="p">,</span>
                 <span class="s">&#39;data_relation&#39;</span><span class="p">:</span> <span class="p">{</span>
                     <span class="s">&#39;resource&#39;</span><span class="p">:</span> <span class="s">&#39;users&#39;</span><span class="p">,</span>
                     <span class="s">&#39;field&#39;</span><span class="p">:</span> <span class="s">&#39;_id&#39;</span><span class="p">,</span>
<span class="hll">                     <span class="s">&#39;embeddable&#39;</span><span class="p">:</span> <span class="bp">True</span>
</span>                 <span class="p">},</span>
             <span class="p">},</span>
             <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;string&#39;</span><span class="p">},</span>
             <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;string&#39;</span><span class="p">},</span>
         <span class="p">}</span>
     <span class="p">}</span>
</pre></div>
</div>
<p>A GET like this: <tt class="docutils literal"><span class="pre">/emails?embedded={&quot;author&quot;:1}</span></tt> would return a fully
embedded users document, whereas the same request without the <tt class="docutils literal"><span class="pre">embedded</span></tt>
argument would just return the user <tt class="docutils literal"><span class="pre">ObjectId</span></tt>. Embedded resource
serialization is available at both resource and item
(<tt class="docutils literal"><span class="pre">/emails/&lt;id&gt;/?embedded={&quot;author&quot;:1}</span></tt>) endpoints.</p>
<p>Embedding can be enabled or disabled both at global level (by setting
<tt class="docutils literal"><span class="pre">EMBEDDING</span></tt> to either <tt class="docutils literal"><span class="pre">True</span></tt> or <tt class="docutils literal"><span class="pre">False</span></tt>) and at resource level (by
toggling the <tt class="docutils literal"><span class="pre">embedding</span></tt> value). Furthermore, only fields with the
<tt class="docutils literal"><span class="pre">embeddable</span></tt> value explicitly set to <tt class="docutils literal"><span class="pre">True</span></tt> will allow the embedding of
referenced documents.</p>
<p>Embedding also works with a data_relation to a specific version of a document,
but the schema looks a little bit different. To enable the data_relation to a
specific version, add <tt class="docutils literal"><span class="pre">'version':</span> <span class="pre">True</span></tt> to the data_relation block. You&#8217;ll
also want to change the <tt class="docutils literal"><span class="pre">type</span></tt> to <tt class="docutils literal"><span class="pre">dict</span></tt> and add the <tt class="docutils literal"><span class="pre">schema</span></tt> definition
shown below.</p>
<div class="highlight-python"><div class="highlight"><pre> <span class="n">DOMAIN</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s">&#39;emails&#39;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s">&#39;schema&#39;</span><span class="p">:</span> <span class="p">{</span>
             <span class="s">&#39;author&#39;</span><span class="p">:</span> <span class="p">{</span>
<span class="hll">                 <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;dict&#39;</span><span class="p">,</span>
</span><span class="hll">                 <span class="s">&#39;schema&#39;</span><span class="p">:</span> <span class="p">{</span>
</span>                     <span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;objectid&#39;</span><span class="p">},</span>
                     <span class="s">&#39;_version&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;integer&#39;</span><span class="p">}</span>
                 <span class="p">},</span>
                 <span class="s">&#39;data_relation&#39;</span><span class="p">:</span> <span class="p">{</span>
<span class="hll">                     <span class="s">&#39;resource&#39;</span><span class="p">:</span> <span class="s">&#39;users&#39;</span><span class="p">,</span>
</span>                     <span class="s">&#39;field&#39;</span><span class="p">:</span> <span class="s">&#39;_id&#39;</span><span class="p">,</span>
                     <span class="s">&#39;embeddable&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                     <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                 <span class="p">},</span>
             <span class="p">},</span>
             <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;string&#39;</span><span class="p">},</span>
             <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;string&#39;</span><span class="p">},</span>
         <span class="p">}</span>
     <span class="p">}</span>
</pre></div>
</div>
<p>As you can see, <tt class="docutils literal"><span class="pre">'version':</span> <span class="pre">True</span></tt> changes the expected value of a
data_relation field to a dictionary with fields names <tt class="docutils literal"><span class="pre">data_relation['field']</span></tt>
and <tt class="docutils literal"><span class="pre">VERSION</span></tt>. With <tt class="docutils literal"><span class="pre">'field':</span> <span class="pre">'_id'</span></tt> in the data_relation definition above
and <tt class="docutils literal"><span class="pre">VERSION</span> <span class="pre">=</span> <span class="pre">'_version'</span></tt> in the Eve config, the value of the data_relation
in this scenario would be a dictionary with fields <tt class="docutils literal"><span class="pre">_id</span></tt> and <tt class="docutils literal"><span class="pre">_version</span></tt>.</p>
<div class="section" id="predefined-resource-serialization">
<h3>Predefined Resource Serialization<a class="headerlink" href="#predefined-resource-serialization" title="Permalink to this headline">¶</a></h3>
<p>It is also possible to elect some fields for predefined resource
serialization. If the listed fields are embeddable and they are actually referencing
documents in other resources (and embedding is enabled for the resource), then the
referenced documents will be embedded by default. Clients can still opt out from field
that are embedded by default:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://example.com/people/?embedded<span class="o">={</span><span class="s2">&quot;author&quot;</span>: 0<span class="o">}</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
</div>
<div class="section" id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h3>
<p>Currently we support embedding of documents by references located in any
subdocuments (nested dicts and lists). For example, a query
<tt class="docutils literal"><span class="pre">/invoices/?embedded={&quot;user.friends&quot;:1}</span></tt> will return a document with <tt class="docutils literal"><span class="pre">user</span></tt>
and all his <tt class="docutils literal"><span class="pre">friends</span></tt> embedded, but only if <tt class="docutils literal"><span class="pre">user</span></tt> is a subdocument and
<tt class="docutils literal"><span class="pre">friends</span></tt> is a list of reference (it could be a list of dicts, nested
dict, etc.). This feature is about serialization on GET requests. There&#8217;s no
support for POST, PUT or PATCH of embedded documents.</p>
<p>Document embedding is enabled by default.</p>
<div class="admonition-please-note admonition">
<p class="first admonition-title">Please note</p>
<p class="last">When it comes to MongoDB, what embedded resource serialization deals with
is <em>document references</em> (linked documents), something different from
<em>embedded documents</em>, also supported by Eve (see <a class="reference external" href="http://docs.mongodb.org/manual/core/data-model-design">MongoDB Data Model
Design</a>). Embedded resource serialization is a nice feature that can
really help with normalizing your data model for the client.  However, when
deciding whether to enable it or not, especially by default, keep in mind
that each embedded resource being looked up will require a database lookup,
which can easily lead to performance issues.</p>
</div>
</div>
</div>
<div class="section" id="soft-delete">
<span id="id6"></span><h2>Soft Delete<a class="headerlink" href="#soft-delete" title="Permalink to this headline">¶</a></h2>
<p>Eve provides an optional &#8220;soft delete&#8221; mode in which deleted documents continue
to be stored in the database and are able to be restored, but still act as
removed items in response to API requests. Soft delete is disabled by default,
but can be enabled globally using the <tt class="docutils literal"><span class="pre">SOFT_DELETE</span></tt> configuration setting, or
individually configured at the resource level using the domain configuration
<tt class="docutils literal"><span class="pre">soft_delete</span></tt> setting. See <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a> and <a class="reference internal" href="config.html#domain"><em>Domain Configuration</em></a> for more
information on enabling and configuring soft delete.</p>
<p>When soft deletion is enabled, callbacks attached to
<tt class="docutils literal"><span class="pre">on_delete_resource_originals</span></tt> and
<tt class="docutils literal"><span class="pre">on_delete_resource_originals_&lt;resource_name&gt;</span></tt> events will receive both
deleted and not deleted documents via the <tt class="docutils literal"><span class="pre">originals</span></tt> argument (see
<a class="reference internal" href="#eventhooks"><em>Event Hooks</em></a>).</p>
<div class="section" id="behavior">
<h3>Behavior<a class="headerlink" href="#behavior" title="Permalink to this headline">¶</a></h3>
<p>With soft delete enabled, DELETE requests to individual items and resources
respond just as they do for a traditional &#8220;hard&#8221; delete. Behind the scenes,
however, Eve does not remove deleted items from the database, but instead
patches the document with a <tt class="docutils literal"><span class="pre">_deleted</span></tt> meta field set to <tt class="docutils literal"><span class="pre">true</span></tt>. (The name
of the <tt class="docutils literal"><span class="pre">_deleted</span></tt> field is configurable. See <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a>.) All requests
made when soft delete is enabled filter against or otherwise account for the
<tt class="docutils literal"><span class="pre">_deleted</span></tt> field.</p>
<p>The <tt class="docutils literal"><span class="pre">_deleted</span></tt> field is automatically added and initialized to <tt class="docutils literal"><span class="pre">false</span></tt> for
all documents created while soft delete is enabled. Documents created prior to
soft delete being enabled and which therefore do not define the <tt class="docutils literal"><span class="pre">_deleted</span></tt>
field in the database will still include <tt class="docutils literal"><span class="pre">_deleted:</span> <span class="pre">false</span></tt> in API response
data, added by Eve during response construction. PUTs or PATCHes to these
documents will add the <tt class="docutils literal"><span class="pre">_deleted</span></tt> field to the stored documents, set to
<tt class="docutils literal"><span class="pre">false</span></tt>.</p>
<p>Responses to GET requests for soft deleted documents vary slightly from
responses to missing or &#8220;hard&#8221; deleted documents. GET requests for soft deleted
documents will still respond with <tt class="docutils literal"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></tt> status codes, but the
response body will contain the soft deleted document with <tt class="docutils literal"><span class="pre">_deleted:</span> <span class="pre">true</span></tt>.
Documents embedded in the deleted document will not be expanded in the
response, regardless of any default settings or the contents of the request&#8217;s
<tt class="docutils literal"><span class="pre">embedded</span></tt> query param. This is to ensure that soft deleted documents
included in <tt class="docutils literal"><span class="pre">404</span></tt> responses reflect the state of a document when it was
deleted, and do not to change if embedded documents are updated.</p>
<p>By default, resource level GET requests will not include soft deleted items in
their response. This behavior matches that of requests after a &#8220;hard&#8221; delete.
If including deleted items in the response is desired, the <tt class="docutils literal"><span class="pre">show_deleted</span></tt>
query param can be added to the request. (the <tt class="docutils literal"><span class="pre">show_deleted</span></tt> param name is
configurable. See <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a>) Eve will respond with all documents, deleted
or not, and it is up to the client to parse returned documents&#8217; <tt class="docutils literal"><span class="pre">_deleted</span></tt>
field. The <tt class="docutils literal"><span class="pre">_deleted</span></tt> field can also be explicitly filtered against in a
request, allowing only deleted documents to be returned using a
<tt class="docutils literal"><span class="pre">?where={&quot;_deleted&quot;:</span> <span class="pre">true}</span></tt> query.</p>
<p>Soft delete is enforced in the data layer, meaning queries made by application
code using the <tt class="docutils literal"><span class="pre">app.data.find_one</span></tt> and <tt class="docutils literal"><span class="pre">app.data.find</span></tt> methods will
automatically filter out soft deleted items. Passing a request object with
<tt class="docutils literal"><span class="pre">req.show_deleted</span> <span class="pre">==</span> <span class="pre">True</span></tt> or a lookup dictionary that explicitly filters on
the <tt class="docutils literal"><span class="pre">_deleted</span></tt> field will override the default filtering.</p>
</div>
<div class="section" id="restoring-soft-deleted-items">
<h3>Restoring Soft Deleted Items<a class="headerlink" href="#restoring-soft-deleted-items" title="Permalink to this headline">¶</a></h3>
<p>PUT or PATCH requests made to a soft deleted document will restore it,
automatically setting <tt class="docutils literal"><span class="pre">_deleted</span></tt> to <tt class="docutils literal"><span class="pre">false</span></tt> in the database. Modifying the
<tt class="docutils literal"><span class="pre">_deleted</span></tt> field directly is not necessary (or allowed). For example, using
PATCH requests, only the fields to be changed in the restored version would be
specified, or an empty request would be made to restore the document as is. The
request must be made with proper authorization for write permission to the soft
deleted document or it will be refused.</p>
<p>Be aware that, should a previously soft deleted document be restored, there is
a chance that an eventual unique field might end up being now duplicated in two
different documents: the restored one, and another which might have been stored
with the same field value while the original (now restored) was in &#8216;deleted&#8217;
state. This is because soft deleted documents are ignored when validating the
<cite>unique</cite> rule for new or updated documents.</p>
</div>
<div class="section" id="versioning">
<h3>Versioning<a class="headerlink" href="#versioning" title="Permalink to this headline">¶</a></h3>
<p>Soft deleting a versioned document creates a new version of that document with
<tt class="docutils literal"><span class="pre">_deleted</span></tt> set to <tt class="docutils literal"><span class="pre">true</span></tt>. A GET request to the deleted version will receive
a <tt class="docutils literal"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></tt> response as described above, while previous versions will
continue to respond with <tt class="docutils literal"><span class="pre">200</span> <span class="pre">OK</span></tt>. Responses to <tt class="docutils literal"><span class="pre">?version=diff</span></tt> or
<tt class="docutils literal"><span class="pre">?version=all</span></tt> will include the deleted version as if it were any other.</p>
</div>
<div class="section" id="data-relations">
<h3>Data Relations<a class="headerlink" href="#data-relations" title="Permalink to this headline">¶</a></h3>
<p>The Eve <tt class="docutils literal"><span class="pre">data_relation</span></tt> validator will not allow references to documents that
have been soft deleted. Attempting to create or update a document with a
reference to a soft deleted document will fail just as if that document had
been hard deleted. Existing data relations to documents that are soft deleted
remain in the database, but requests requiring embedded document serialization
of those relations will resolve to a null value. Again, this matches the
behavior of relations to hard deleted documents.</p>
<p>Versioned data relations to a deleted document version will also fail to
validate, but relations to versions prior to deletion or after restoration of
the document are allowed and will continue to resolve successfully.</p>
</div>
<div class="section" id="considerations">
<h3>Considerations<a class="headerlink" href="#considerations" title="Permalink to this headline">¶</a></h3>
<p>Disabling soft delete after use in an application requires database maintenance
to ensure your API remains consistent. With soft delete disabled, requests will
no longer filter against or handle the <tt class="docutils literal"><span class="pre">_deleted</span></tt> field, and documents that
were soft deleted will now be live again on your API. It is therefore necessary
when disabling soft delete to perform a data migration to remove all documents
with <tt class="docutils literal"><span class="pre">_deleted</span> <span class="pre">==</span> <span class="pre">True</span></tt>, and recommended to remove the <tt class="docutils literal"><span class="pre">_deleted</span></tt> field
from documents where <tt class="docutils literal"><span class="pre">_deleted</span> <span class="pre">==</span> <span class="pre">False</span></tt>. Enabling soft delete in an existing
application is safe, and will maintain documents deleted from that point on.</p>
</div>
</div>
<div class="section" id="event-hooks">
<span id="eventhooks"></span><h2>Event Hooks<a class="headerlink" href="#event-hooks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pre-request-event-hooks">
<h3>Pre-Request Event Hooks<a class="headerlink" href="#pre-request-event-hooks" title="Permalink to this headline">¶</a></h3>
<p>When a GET/HEAD, POST, PATCH, PUT, DELETE request is received, both
a <tt class="docutils literal"><span class="pre">on_pre_&lt;method&gt;</span></tt> and a <tt class="docutils literal"><span class="pre">on_pre_&lt;method&gt;_&lt;resource&gt;</span></tt> event is raised.
You can subscribe to these events with multiple callback functions.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">pre_get_callback</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;A GET request on the &quot;</span><span class="si">%s</span><span class="s">&quot; endpoint has just been received!&#39;</span> <span class="o">%</span> <span class="n">resource</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">pre_contacts_get_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;A GET request on the contacts endpoint has just been received!&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_pre_GET</span> <span class="o">+=</span> <span class="n">pre_get_callback</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_pre_GET_contacts</span> <span class="o">+=</span> <span class="n">pre_contacts_get_callback</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Callbacks will receive the resource being requested, the original
<tt class="docutils literal"><span class="pre">flask.request</span></tt> object and the current lookup dictionary as arguments (only
exception being the <tt class="docutils literal"><span class="pre">on_pre_POST</span></tt> hook which does not provide a <tt class="docutils literal"><span class="pre">lookup</span></tt>
argument).</p>
<div class="section" id="dynamic-lookup-filters">
<h4>Dynamic Lookup Filters<a class="headerlink" href="#dynamic-lookup-filters" title="Permalink to this headline">¶</a></h4>
<p>Since the <tt class="docutils literal"><span class="pre">lookup</span></tt> dictionary will be used by the data layer to retrieve
resource documents, developers may choose to alter it in order to add custom
logic to the lookup query.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">pre_GET</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">lookup</span><span class="p">):</span>
    <span class="c"># only return documents that have a &#39;username&#39; field.</span>
    <span class="n">lookup</span><span class="p">[</span><span class="s">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$exists&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">on_pre_GET</span> <span class="o">+=</span> <span class="n">pre_GET</span>
<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Altering the lookup dictionary at runtime would have similar effects to
applying <a class="reference internal" href="config.html#filter"><em>Predefined Database Filters</em></a> via configuration. However, you can only set static
filters via configuration whereas by hooking to the <tt class="docutils literal"><span class="pre">on_pre_&lt;METHOD&gt;</span></tt> events
you are allowed to set dynamic filters instead, which allows for additional
flexibility.</p>
</div>
</div>
<div class="section" id="post-request-event-hooks">
<h3>Post-Request Event Hooks<a class="headerlink" href="#post-request-event-hooks" title="Permalink to this headline">¶</a></h3>
<p>When a GET, POST, PATCH, PUT, DELETE method has been executed, both
a <tt class="docutils literal"><span class="pre">on_post_&lt;method&gt;</span></tt> and <tt class="docutils literal"><span class="pre">on_post_&lt;method&gt;_&lt;resource&gt;</span></tt> event is raised. You
can subscribe to these events with multiple callback functions. Callbacks will
receive the resource accessed, original <cite>flask.request</cite> object and the response
payload.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">post_get_callback</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;A GET on the &quot;</span><span class="si">%s</span><span class="s">&quot; endpoint was just performed!&#39;</span> <span class="o">%</span> <span class="n">resource</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">post_contacts_get_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;A get on &quot;contacts&quot; was just performed!&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_post_GET</span> <span class="o">+=</span> <span class="n">post_get_callback</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_post_GET_contacts</span> <span class="o">+=</span> <span class="n">post_contacts_get_callback</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="database-event-hooks">
<h3>Database event hooks<a class="headerlink" href="#database-event-hooks" title="Permalink to this headline">¶</a></h3>
<p>Database event hooks work like request event hooks. These events are fired
before and after a database action. Here is an example of how events are
configured:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">add_signature</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">response</span><span class="p">[</span><span class="s">&#39;SIGNATURE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;A </span><span class="si">%s</span><span class="s"> from eve&quot;</span> <span class="o">%</span> <span class="n">resource</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_fetched_item</span> <span class="o">+=</span> <span class="n">add_signature</span>
</pre></div>
</div>
<p>You may use flask&#8217;s <tt class="docutils literal"><span class="pre">abort()</span></tt> to interrupt the database operation:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">check_update_access</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">original</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_insert_item</span> <span class="o">+=</span> <span class="n">check_update_access</span>
</pre></div>
</div>
<p>The events are fired for resources and items if the action is available for
both. And for each action two events will be fired:</p>
<ul class="simple">
<li>Generic: <tt class="docutils literal"><span class="pre">on_&lt;action_name&gt;</span></tt></li>
<li>With the name of the resource: <tt class="docutils literal"><span class="pre">on_&lt;action_name&gt;_&lt;resource_name&gt;</span></tt></li>
</ul>
<p>Let&#8217;s see an overview of what events are available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="11%" />
<col width="8%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action</th>
<th class="head">What</th>
<th class="head">When</th>
<th class="head">Event name / method signature</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td rowspan="4">Fetch</td>
<td rowspan="2">Resource</td>
<td rowspan="2">After</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_fetched_resource</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">response)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_fetched_resource_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(response)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="2">Item</td>
<td rowspan="2">After</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_fetched_item</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">response)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_fetched_item_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(response)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="4">Insert</td>
<td rowspan="4">Items</td>
<td rowspan="2">Before</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_insert</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">items)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_insert_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(items)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="2">After</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_inserted</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">items)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_inserted_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(items)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="4">Replace</td>
<td rowspan="4">Item</td>
<td rowspan="2">Before</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_replace</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">item,</span> <span class="pre">original)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_replace_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(item,</span> <span class="pre">original)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="2">After</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_replaced</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">item,</span> <span class="pre">original)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_replaced_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(item,</span> <span class="pre">original)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="4">Update</td>
<td rowspan="4">Item</td>
<td rowspan="2">Before</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_update</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">updates,</span> <span class="pre">original)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_update_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(updates,</span> <span class="pre">original)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="2">After</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_updated</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">updates,</span> <span class="pre">original)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_updated_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(updates,</span> <span class="pre">original)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="10">Delete</td>
<td rowspan="4">Item</td>
<td rowspan="2">Before</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_delete_item</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">item)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_delete_item_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(item)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="2">After</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_deleted_item</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">item)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_deleted_item_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(item)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="6">Resource</td>
<td rowspan="4">Before</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_delete_resource</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_delete_resource_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event()</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_delete_resource_originals</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">originals,</span> <span class="pre">lookup)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_delete_resource_originals_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(originals,</span> <span class="pre">lookup)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-even"><td rowspan="2">After</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_deleted_resource</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(resource_name,</span> <span class="pre">item)</span></tt></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">on_deleted_resource_&lt;resource_name&gt;</span></tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">def</span> <span class="pre">event(item)</span></tt></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="fetch-events">
<h4>Fetch Events<a class="headerlink" href="#fetch-events" title="Permalink to this headline">¶</a></h4>
<p>These are the fetch events with their method signature:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_fetched_resource(resource_name,</span> <span class="pre">response)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_fetched_resource_&lt;resource_name&gt;(response)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_fetched_item(resource_name,</span> <span class="pre">response)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_fetched_item_&lt;resource_name&gt;(response)</span></tt></li>
</ul>
<p>They are raised when items have just been read from the database and are
about to be sent to the client. Registered callback functions can manipulate
the items as needed before they are returned to the client.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">before_returning_items</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to return items from &quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span> <span class="o">%</span> <span class="n">resource_name</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">before_returning_contacts</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to return contacts&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">before_returning_item</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to return an item from &quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span> <span class="o">%</span> <span class="n">resource_name</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">before_returning_contact</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to return a contact&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_fetched_resource</span> <span class="o">+=</span> <span class="n">before_returning_items</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_fetched_resource_contacts</span> <span class="o">+=</span> <span class="n">before_returning_contacts</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_fetched_item</span> <span class="o">+=</span> <span class="n">before_returning_item</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_fetched_item_contacts</span> <span class="o">+=</span> <span class="n">before_returning_contact</span>
</pre></div>
</div>
<p>It is important to note that fetch events will work with <a class="reference internal" href="#id4">Document
Versioning</a> for specific document versions or accessing all document
versions with <tt class="docutils literal"><span class="pre">?version=all</span></tt>, but they <em>will not</em> work when acessing diffs
of all versions with <tt class="docutils literal"><span class="pre">?version=diffs</span></tt>.</p>
</div>
<div class="section" id="insert-events">
<h4>Insert Events<a class="headerlink" href="#insert-events" title="Permalink to this headline">¶</a></h4>
<p>These are the insert events with their method signature:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_insert(resource_name,</span> <span class="pre">items)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_insert_&lt;resource_name&gt;(items)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_inserted(resource_name,</span> <span class="pre">items)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_inserted_&lt;resource_name&gt;(items)</span></tt></li>
</ul>
<p>When a POST requests hits the API and new items are about to be stored in
the database, these vents are fired:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_insert</span></tt> for every resource endpoint.</li>
<li><tt class="docutils literal"><span class="pre">on_insert_&lt;resource_name&gt;</span></tt> for the specific <cite>&lt;resource_name&gt;</cite> resource
endpoint.</li>
</ul>
<p>Callback functions could hook into these events to arbitrarily add new fields
or edit existing ones.</p>
<p>After the items have been inserted, these two events are fired:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_inserted</span></tt> for every resource endpoint.</li>
<li><tt class="docutils literal"><span class="pre">on_inserted_&lt;resource_name&gt;</span></tt> for the specific <cite>&lt;resource_name&gt;</cite> resource
endpoint.</li>
</ul>
<div class="admonition-validation-errors admonition">
<p class="first admonition-title">Validation errors</p>
<p class="last">Items passed to these events as arguments come in a list. And only those items
that passed validation are sent.</p>
</div>
<p>Example:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">before_insert</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to store items to &quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span> <span class="o">%</span> <span class="n">resource</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">after_insert_contacts</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<span class="gp">... </span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;About to store contacts&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_insert</span> <span class="o">+=</span> <span class="n">before_insert</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">on_inserted_contacts</span> <span class="o">+=</span> <span class="n">after_insert_contacts</span>
</pre></div>
</div>
</div>
<div class="section" id="replace-events">
<h4>Replace Events<a class="headerlink" href="#replace-events" title="Permalink to this headline">¶</a></h4>
<p>These are the replace events with their method signature:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_replace(resource_name,</span> <span class="pre">item,</span> <span class="pre">original)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_replace_&lt;resource_name&gt;(item,</span> <span class="pre">original)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_replaced(resource_name,</span> <span class="pre">item,</span> <span class="pre">original)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_replaced_&lt;resource_name&gt;(item,</span> <span class="pre">original)</span></tt></li>
</ul>
<p>When a PUT request hits the API and an item is about to be replaced after
passing validation, these events are fired:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_replace</span></tt> for any resource item endpoint.</li>
<li><tt class="docutils literal"><span class="pre">on_replace_&lt;resource_name&gt;</span></tt> for the specific resource endpoint.</li>
</ul>
<p><cite>item</cite> is the new item which is about to be stored. <cite>original</cite> is the item in
the database that is being replaced. Callback functions could hook into these
events to arbitrarily add or update <cite>item</cite> fields, or to perform other
accessory action.</p>
<p>After the item has been replaced, these other two events are fired:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_replaced</span></tt> for any resource item endpoint.</li>
<li><tt class="docutils literal"><span class="pre">on_replaced_&lt;resource_name&gt;</span></tt> for the specific resource endpont.</li>
</ul>
</div>
<div class="section" id="update-events">
<h4>Update Events<a class="headerlink" href="#update-events" title="Permalink to this headline">¶</a></h4>
<p>These are the update events with their method signature:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_update(resource_name,</span> <span class="pre">updates,</span> <span class="pre">original)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_update_&lt;resource_name&gt;(updates,</span> <span class="pre">original)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_updated(resource_name,</span> <span class="pre">updates,</span> <span class="pre">original)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_updated_&lt;resource_name&gt;(updates,</span> <span class="pre">original)</span></tt></li>
</ul>
<p>When a PATCH request hits the API and an item is about to be updated after
passing validation, these events are fired <cite>before</cite> the item is updated:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_update</span></tt> for any resource endpoint.</li>
<li><tt class="docutils literal"><span class="pre">on_update_&lt;resource_name&gt;</span></tt> is fired only when the <cite>&lt;resource_name&gt;</cite>
endpoint is hit.</li>
</ul>
<p>Here <cite>updates</cite> stands for updates being applied to the item and <cite>original</cite> is
the item in the database that is about to be updated. Callback functions
could hook into these events to arbitrarily add or update fields in
<cite>updates</cite>, or to perform other accessory action.</p>
<p><cite>After</cite> the item has been updated:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_updated</span></tt> is fired for any resource endpoint.</li>
<li><tt class="docutils literal"><span class="pre">on_updated_&lt;resource_name&gt;</span></tt> is fired only when the <cite>&lt;resource_name&gt;</cite>
endpoint is hit.</li>
</ul>
<div class="admonition-please-note admonition">
<p class="first admonition-title">Please note</p>
<p class="last">Please be aware that <tt class="docutils literal"><span class="pre">last_modified</span></tt> and <tt class="docutils literal"><span class="pre">etag</span></tt> headers will always be
consistent with the state of the items on the database (they  won&#8217;t be
updated to reflect changes eventually applied by the callback functions).</p>
</div>
</div>
<div class="section" id="delete-events">
<h4>Delete Events<a class="headerlink" href="#delete-events" title="Permalink to this headline">¶</a></h4>
<p>These are the delete events with their method signature:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_delete_item(resource_name,</span> <span class="pre">item)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_delete_item_&lt;resource_name&gt;(item)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_deleted_item(resource_name,</span> <span class="pre">item)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_deleted_item_&lt;resource_name&gt;(item)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_delete_resource(resource_name)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_delete_resource_&lt;resource_name&gt;()</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_delete_resource_originals(originals,</span> <span class="pre">lookup)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_delete_resource_originals_&lt;resource_name&gt;(originals,</span> <span class="pre">lookup)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_deleted_resource(resource_name)</span></tt></li>
<li><tt class="docutils literal"><span class="pre">on_deleted_resource_&lt;resource_name&gt;()</span></tt></li>
</ul>
<div class="section" id="items">
<h5>Items<a class="headerlink" href="#items" title="Permalink to this headline">¶</a></h5>
<p>When a DELETE request hits an item endpoint and <cite>before</cite> the item is deleted,
these events are fired:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_delete_item</span></tt> for any resource hit by the request.</li>
<li><tt class="docutils literal"><span class="pre">on_delete_item_&lt;resource_name&gt;</span></tt> for the specific <cite>&lt;resource_name&gt;</cite> item endpoint
hit by the DELETE.</li>
</ul>
<p><cite>After</cite> the item has been deleted the <tt class="docutils literal"><span class="pre">on_deleted_item(resource_name,</span>
<span class="pre">item)</span></tt> and <tt class="docutils literal"><span class="pre">on_deleted_item_&lt;resource_name&gt;(item)</span></tt> are raised.</p>
<p><cite>item</cite> is the item being deleted. Callback functions could hook into
these events to perform accessory actions. And no you can&#8217;t arbitrarily abort
the delete operation at this point (you should probably look at
<a class="reference internal" href="validation.html#validation"><em>Data Validation</em></a>, or eventually disable the delete command altogether).</p>
</div>
<div class="section" id="resources">
<h5>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h5>
<p>If you were brave enough to enable the DELETE command on resource endpoints
(allowing for wipeout of the entire collection in one go), then you can be
notified of such a disastrous occurrence by hooking a callback function to the
<tt class="docutils literal"><span class="pre">on_delete_resource(resource_name)</span></tt> or
<tt class="docutils literal"><span class="pre">on_delete_resource_&lt;resource_name&gt;()</span></tt> hooks.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">on_delete_resource_originals</span></tt> for any resource hit by the request after having retrieved the originals documents.</li>
<li><tt class="docutils literal"><span class="pre">on_delete_resource_originals_&lt;resource_name&gt;</span></tt> for the specific <cite>&lt;resource_name&gt;</cite> resource endpoint
hit by the DELETE after having retrieved the original document. NOTE: those two event are useful in order to
perform some business logic before the actual remove operation given the look up and the list of originals</li>
</ul>
</div>
</div>
</div>
<div class="section" id="aggregation-event-hooks">
<span id="aggregation-hooks"></span><h3>Aggregation event hooks<a class="headerlink" href="#aggregation-event-hooks" title="Permalink to this headline">¶</a></h3>
<p>You can also attach one or more callbacks to your aggregation endpoints. The
<tt class="docutils literal"><span class="pre">before_aggregation</span></tt> event is fired when an aggregation is about to be
performed. Any attached callback function will receive both the endpoint name
and the aggregation pipeline as arguments. The pipeline can then be altered if
needed.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">on_aggregate</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">):</span>
<span class="gp">... </span>  <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s">&quot;$tags&quot;</span><span class="p">})</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">before_aggregation</span> <span class="o">+=</span> <span class="n">on_aggregate</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">after_aggregation</span></tt> event is fired when the aggregation has been
performed. An attached callback function could leverage this event to modify
the documents before they are returned to the client.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">alter_documents</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">documents</span><span class="p">):</span>
<span class="gp">... </span>  <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">document</span><span class="p">[</span><span class="s">&#39;hello&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;well, hello!&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">after_aggregation</span> <span class="o">+=</span> <span class="n">alter_documents</span>
</pre></div>
</div>
<p>For more information on aggregation support, see <a class="reference internal" href="#aggregation"><em>MongoDB Aggregation Framework</em></a></p>
<div class="admonition-please-note admonition">
<p class="first admonition-title">Please note</p>
<p class="last">To provide seamless event handling features Eve relies on the <a class="reference external" href="https://github.com/pyeve/events">Events</a> package.</p>
</div>
</div>
</div>
<div class="section" id="rate-limiting">
<span id="ratelimiting"></span><h2>Rate Limiting<a class="headerlink" href="#rate-limiting" title="Permalink to this headline">¶</a></h2>
<p>API rate limiting is supported on a per-user/method basis. You can set the
number of requests and the time window for each HTTP method. If the requests
limit is hit within the time window, the API will respond with <tt class="docutils literal"><span class="pre">429</span> <span class="pre">Request</span>
<span class="pre">limit</span> <span class="pre">exceeded</span></tt> until the timer resets. Users are identified by the
Authentication header or (when missing) by the client IP. When rate limiting
is enabled, appropriate <tt class="docutils literal"><span class="pre">X-RateLimit-</span></tt> headers are provided with every API
response.  Suppose that the rate limit has been set to 300 requests every 15
minutes, this is what a user would get after hitting a endpoint with a single
request:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">X</span><span class="o">-</span><span class="n">RateLimit</span><span class="o">-</span><span class="n">Remaining</span><span class="p">:</span> <span class="mi">299</span>
<span class="n">X</span><span class="o">-</span><span class="n">RateLimit</span><span class="o">-</span><span class="n">Limit</span><span class="p">:</span> <span class="mi">300</span>
<span class="n">X</span><span class="o">-</span><span class="n">RateLimit</span><span class="o">-</span><span class="n">Reset</span><span class="p">:</span> <span class="mi">1370940300</span>
</pre></div>
</div>
<p>You can set different limits for each one of the supported methods (GET, POST,
PATCH, DELETE).</p>
<div class="admonition-please-note admonition">
<p class="first admonition-title">Please Note</p>
<p class="last">Rate Limiting is disabled by default, and needs a Redis server running when
enabled. A tutorial on Rate Limiting is forthcoming.</p>
</div>
</div>
<div class="section" id="custom-id-fields">
<h2>Custom ID Fields<a class="headerlink" href="#custom-id-fields" title="Permalink to this headline">¶</a></h2>
<p>Eve allows to extend its standard data type support. In the <a class="reference internal" href="tutorials/custom_idfields.html#custom-ids"><em>Handling custom ID fields</em></a>
tutorial we see how it is possible to use UUID values instead of MongoDB
default ObjectIds as unique document identifiers.</p>
</div>
<div class="section" id="file-storage">
<h2>File Storage<a class="headerlink" href="#file-storage" title="Permalink to this headline">¶</a></h2>
<p>Media files (images, pdf, etc.) can be uploaded as <tt class="docutils literal"><span class="pre">media</span></tt> document
fields. Upload is done via <tt class="docutils literal"><span class="pre">POST</span></tt>, <tt class="docutils literal"><span class="pre">PUT</span></tt> and
<tt class="docutils literal"><span class="pre">PATCH</span></tt> as usual, but using the <tt class="docutils literal"><span class="pre">multipart/form-data</span></tt> content-type.</p>
<p>Let us assume that the <tt class="docutils literal"><span class="pre">accounts</span></tt> endpoint has a schema like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">accounts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;string&#39;</span><span class="p">},</span>
    <span class="s">&#39;pic&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;media&#39;</span><span class="p">},</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With curl we would <tt class="docutils literal"><span class="pre">POST</span></tt> like this:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -F <span class="s2">&quot;name=john&quot;</span> -F <span class="s2">&quot;pic=@profile.jpg&quot;</span> http://example.com/accounts
</pre></div>
</div>
<p>For optimized performance files are stored in <a class="reference external" href="http://docs.mongodb.org/manual/core/gridfs/">GridFS</a> by default. Custom
<tt class="docutils literal"><span class="pre">MediaStorage</span></tt> classes can be implemented and passed to the application to
support alternative storage systems. A <tt class="docutils literal"><span class="pre">FileSystemMediaStorage</span></tt> class is in
the works, and will soon be included with the Eve package.</p>
<p>As a proper developer guide is not available yet, you can peek at the
<a class="reference external" href="https://github.com/pyeve/eve/blob/develop/eve/io/media.py">MediaStorage</a> source if you are interested in developing custom storage
classes.</p>
<div class="section" id="serving-media-files-as-base64-strings">
<h3>Serving media files as Base64 strings<a class="headerlink" href="#serving-media-files-as-base64-strings" title="Permalink to this headline">¶</a></h3>
<p>When a document is requested media files will be returned as Base64 strings,</p>
<div class="highlight-python"><div class="highlight"><pre> <span class="p">{</span>
     <span class="s">&#39;_items&#39;</span><span class="p">:</span> <span class="p">[</span>
         <span class="p">{</span>
             <span class="s">&#39;_updated&#39;</span><span class="p">:</span><span class="s">&#39;Sat, 05 Apr 2014 15:52:53 GMT&#39;</span><span class="p">,</span>
             <span class="s">&#39;pic&#39;</span><span class="p">:</span><span class="s">&#39;iVBORw0KGgoAAAANSUhEUgAAA4AAAAOACA...&#39;</span><span class="p">,</span>
         <span class="p">}</span>
     <span class="p">]</span>
     <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>However, if the <tt class="docutils literal"><span class="pre">EXTENDED_MEDIA_INFO</span></tt> list is populated (it isn&#8217;t by
default) the payload format will be different. This flag allows passthrough
from the driver of additional meta fields. For example, using the MongoDB
driver, fields like <tt class="docutils literal"><span class="pre">content_type</span></tt>, <tt class="docutils literal"><span class="pre">name</span></tt> and <tt class="docutils literal"><span class="pre">length</span></tt> can be added to
this list and will be passed-through from the underlying driver.</p>
<p>When <tt class="docutils literal"><span class="pre">EXTENDED_MEDIA_INFO</span></tt> is used the field will be a dictionary
whereas the file itself is stored under the <tt class="docutils literal"><span class="pre">file</span></tt> key and other keys
are the meta fields. Suppose that the flag is set like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">EXTENDED_MEDIA_INFO</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;length&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Then the output will be something like</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&#39;_items&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s">&#39;_updated&#39;</span><span class="p">:</span><span class="s">&#39;Sat, 05 Apr 2014 15:52:53 GMT&#39;</span><span class="p">,</span>
            <span class="s">&#39;pic&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;file&#39;</span><span class="p">:</span> <span class="s">&#39;iVBORw0KGgoAAAANSUhEUgAAA4AAAAOACA...&#39;</span><span class="p">,</span>
                <span class="s">&#39;content_type&#39;</span><span class="p">:</span> <span class="s">&#39;text/plain&#39;</span><span class="p">,</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;test.txt&#39;</span><span class="p">,</span>
                <span class="s">&#39;length&#39;</span><span class="p">:</span> <span class="mi">8129</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For MongoDB, further fields can be found in the <a class="reference external" href="http://api.mongodb.org/python/2.7rc0/api/gridfs/grid_file.html#gridfs.grid_file.GridOut">driver documentation</a>.</p>
<p>If you have other means to retrieve the media files (custom Flask endpoint for
example) then the media files can be excluded from the payload by setting to
<tt class="docutils literal"><span class="pre">False</span></tt> the <tt class="docutils literal"><span class="pre">RETURN_MEDIA_AS_BASE64_STRING</span></tt> flag. This takes into account
if <tt class="docutils literal"><span class="pre">EXTENDED_MEDIA_INFO</span></tt> is used.</p>
</div>
<div class="section" id="serving-media-files-at-a-dedicated-endpoint">
<h3>Serving media files at a dedicated endpoint<a class="headerlink" href="#serving-media-files-at-a-dedicated-endpoint" title="Permalink to this headline">¶</a></h3>
<p>While returning files embedded as Base64 fields is the default behaviour, you
can opt for serving them at a dedicated media endpoint. You achieve that by
setting <tt class="docutils literal"><span class="pre">RETURN_MEDIA_AS_URL</span></tt> to <tt class="docutils literal"><span class="pre">True</span></tt>. When this feature is enabled
document fields contain urls to the correspondent files, which are served at the
media endpoint.</p>
<p>You can change the default media endpoint (<tt class="docutils literal"><span class="pre">media</span></tt>) by updating the
<tt class="docutils literal"><span class="pre">MEDIA_BASE_URL</span></tt> and <tt class="docutils literal"><span class="pre">MEDIA_ENDPOINT</span></tt> setting. Suppose you are storing your
images on Amazon S3 via a custom <tt class="docutils literal"><span class="pre">MediaStorage</span></tt> subclass. You would probably
set your media endpoint like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># disable default behaviour</span>
<span class="n">RETURN_MEDIA_AS_BASE64_STRING</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># return media as URL instead</span>
<span class="n">RETURN_MEDIA_AS_URL</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c"># set up the desired media endpoint</span>
<span class="n">MEDIA_BASE_URL</span> <span class="o">=</span> <span class="s">&#39;https://s3-us-west-2.amazonaws.com&#39;</span>
<span class="n">MEDIA_ENDPOINT</span> <span class="o">=</span> <span class="s">&#39;media&#39;</span>
</pre></div>
</div>
<p>Setting <tt class="docutils literal"><span class="pre">MEDIA_BASE_URL</span></tt> is optional. If no value is set, then
the API base address will be used when building the URL for <tt class="docutils literal"><span class="pre">MEDIA_ENDPOINT</span></tt>.</p>
</div>
<div class="section" id="partial-media-downloads">
<span id="partial-request"></span><h3>Partial media downloads<a class="headerlink" href="#partial-media-downloads" title="Permalink to this headline">¶</a></h3>
<p>When files are served at a dedicated endpoint, clients can request partial
downloads. This allows them to provide features such as optimized
pause/resume (with no need to restart the download). To perform a partial
download, make sure the <tt class="docutils literal"><span class="pre">Range</span></tt> header is added the the client request.</p>
<blockquote>
<div><div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl http://localhost/media/yourfile -i -H <span class="s2">&quot;Range: bytes=0-10&quot;</span>
<span class="go">HTTP/1.1 206 PARTIAL CONTENT</span>
<span class="go">Date: Sun, 20 Aug 2017 14:26:42 GMT</span>
<span class="go">Content-Type: audio/mp4</span>
<span class="go">Content-Length: 11</span>
<span class="go">Connection: keep-alive</span>
<span class="go">Content-Range: bytes 0-10/23671</span>
<span class="go">Last-Modified: Sat, 19 Aug 2017 03:25:36 GMT</span>
<span class="go">Accept-Ranges: bytes</span>

<span class="go">abcdefghilm</span>
</pre></div>
</div>
</div></blockquote>
<p>In the snippet above, we see curl requesting the first chunk of a file.</p>
</div>
<div class="section" id="leveraging-projections-to-optimize-the-handling-of-media-files">
<span id="projection-filestorage"></span><h3>Leveraging Projections to optimize the handling of media files<a class="headerlink" href="#leveraging-projections-to-optimize-the-handling-of-media-files" title="Permalink to this headline">¶</a></h3>
<p>Clients and API maintainers can exploit the <a class="reference internal" href="#projections"><em>Projections</em></a> feature to
include/exclude media fields from response payloads.</p>
<p>Suppose that a client stored a document with an image. The image field is
called <em>image</em> and it is of <tt class="docutils literal"><span class="pre">media</span></tt> type. At a later time, the client wants
to retrieve the same document but, in order to optimize for speed and since the
image is cached already, it does not want to download the image along with the
document. It can do so by requesting the field to be trimmed out of the
response payload:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://example.com/people/&lt;id&gt;?projection<span class="o">={</span><span class="s2">&quot;image&quot;</span>: 0<span class="o">}</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>The document will be returned with all its fields except the <em>image</em> field.</p>
<p>Moreover, when setting the <tt class="docutils literal"><span class="pre">datasource</span></tt> property for any given resource
endpoint it is possible to explicitly exclude fields (of <tt class="docutils literal"><span class="pre">media</span></tt> type, but
also of any other type) from default responses:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">people</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;datasource&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;projection&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;image&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now clients will have to explicitly request the image field to be included with
response payloads by sending requests like this one:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://example.com/people/&lt;id&gt;?projection<span class="o">={</span><span class="s2">&quot;image&quot;</span>: 1<span class="o">}</span>
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<div class="admonition-see-also admonition">
<p class="first admonition-title">See also</p>
<ul class="simple">
<li><a class="reference internal" href="config.html#config"><em>Configuration</em></a></li>
<li><a class="reference internal" href="config.html#datasource"><em>Advanced Datasource Patterns</em></a></li>
</ul>
<p class="last">for details on the <tt class="docutils literal"><span class="pre">datasource</span></tt> setting.</p>
</div>
</div>
<div class="section" id="note-on-media-files-as-multipart-form-data">
<span id="multipart"></span><h3>Note on media files as <tt class="docutils literal"><span class="pre">multipart/form-data</span></tt><a class="headerlink" href="#note-on-media-files-as-multipart-form-data" title="Permalink to this headline">¶</a></h3>
<p>If you are uploading media files as <tt class="docutils literal"><span class="pre">multipart/form-data</span></tt> all the
additional fields except the file fields will be treated as <tt class="docutils literal"><span class="pre">strings</span></tt>
for all field validation purposes.  If you have already defined some of
the resource fields to be of different type (boolean, number, list etc)
the validation rules for these fields would fail, preventing you to
succesffully submit your resource.</p>
<p>If you still want to be able to perform field validation in this case, you
will have to turn on <tt class="docutils literal"><span class="pre">MULTIPART_FORM_FIELDS_AS_JSON</span></tt> in your settings
file in order to treat the incoming fields as JSON encoded strings and still
be able to validate your fields.</p>
<p>Please note, that in case you indeed turn on <tt class="docutils literal"><span class="pre">MULTIPART_FORM_FIELDS_AS_JSON</span></tt>
you will have to submit all resource fields as properly encoded JSON strings.</p>
<p>For example a <tt class="docutils literal"><span class="pre">number</span></tt> should be submited as <tt class="docutils literal"><span class="pre">1234</span></tt> (as you would normally
expect). A <tt class="docutils literal"><span class="pre">boolean</span></tt> will have to be send as <tt class="docutils literal"><span class="pre">true</span></tt> (note the lowercase
<tt class="docutils literal"><span class="pre">t</span></tt>). A <tt class="docutils literal"><span class="pre">list</span></tt> of strings as <tt class="docutils literal"><span class="pre">[&quot;abc&quot;,</span> <span class="pre">&quot;xyz&quot;]</span></tt>. And finally
a <tt class="docutils literal"><span class="pre">string</span></tt>, which is the thing that will most likely trip, you will have
to be submitted as <tt class="docutils literal"><span class="pre">&quot;'abc'&quot;</span></tt> (note that it is surrounded with double
quotes). If ever in doubt if what you are submitting is a valid JSON string
you can try passing it from the JSON Validator at <a class="reference external" href="http://jsonlint.com/">http://jsonlint.com/</a> to
be sure that it is correct.</p>
</div>
<div class="section" id="using-lists-of-media">
<span id="media-lists"></span><h3>Using lists of media<a class="headerlink" href="#using-lists-of-media" title="Permalink to this headline">¶</a></h3>
<p>When using lists of media, there is no way to submit these in the default
configuration. Enable <tt class="docutils literal"><span class="pre">AUTO_COLLAPSE_MULTI_KEYS</span></tt> and <tt class="docutils literal"><span class="pre">AUTO_CREATE_LISTS</span></tt>
to make this possible. This allows to send multiple values for one key in
<tt class="docutils literal"><span class="pre">multipart/form-data</span></tt> requests and in this way upload a list of files.</p>
</div>
</div>
<div class="section" id="geojson">
<span id="geojson-feature"></span><h2>GeoJSON<a class="headerlink" href="#geojson" title="Permalink to this headline">¶</a></h2>
<p>The MongoDB data layer supports geographic data structures
encoded in <a class="reference external" href="http://geojson.org/">GeoJSON</a> format. All GeoJSON objects supported by <a class="reference external" href="http://docs.mongodb.org/manual/applications/geospatial-indexes/#geojson-objects">MongoDB</a> are available:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">Point</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Multipoint</span></tt></li>
<li><tt class="docutils literal"><span class="pre">LineString</span></tt></li>
<li><tt class="docutils literal"><span class="pre">MultiLineString</span></tt></li>
<li><tt class="docutils literal"><span class="pre">Polygon</span></tt></li>
<li><tt class="docutils literal"><span class="pre">MultiPolygon</span></tt></li>
<li><tt class="docutils literal"><span class="pre">GeometryCollection</span></tt></li>
</ul>
</div></blockquote>
<p>All these objects are implemented as native Eve data types (see <a class="reference internal" href="config.html#schema"><em>Schema Definition</em></a>)
so they are are subject to the proper validation.</p>
<p>In the example below we are extending the <cite>people</cite> endpoint by adding
a <tt class="docutils literal"><span class="pre">location</span></tt> field is of type <a class="reference external" href="http://geojson.org/geojson-spec.html#point">Point</a>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">people</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="s1">&#39;location&#39;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;point&#39;</span>
    <span class="p">},</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Storing a contact along with its location is pretty straightforward:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -d <span class="s1">&#39;[{&quot;firstname&quot;: &quot;barack&quot;, &quot;lastname&quot;: &quot;obama&quot;, &quot;location&quot;: {&quot;type&quot;:&quot;Point&quot;,&quot;coordinates&quot;:[100.0,10.0]}}]&#39;</span> -H <span class="s1">&#39;Content-Type: application/json&#39;</span>  http://127.0.0.1:5000/people
<span class="go">HTTP/1.1 201 OK</span>
</pre></div>
</div>
<p>Eve also supports GeoJSON <tt class="docutils literal"><span class="pre">Feature</span></tt> and <tt class="docutils literal"><span class="pre">FeatureCollection</span></tt> objects, which
are not explicitely mentioned in <a class="reference external" href="http://docs.mongodb.org/manual/applications/geospatial-indexes/#geojson-objects">MongoDB</a> documentation. GeoJSON specification
allows object to contain any number of members (name/value pairs). Eve
validation was implemented to be more strict, allowing only two members. This
restriction can be disabled by setting <tt class="docutils literal"><span class="pre">ALLOW_CUSTOM_FIELDS_IN_GEOJSON</span></tt> to
<tt class="docutils literal"><span class="pre">True</span></tt>.</p>
<div class="section" id="querying-geojson-data">
<h3>Querying GeoJSON Data<a class="headerlink" href="#querying-geojson-data" title="Permalink to this headline">¶</a></h3>
<p>As a general rule all MongoDB <a class="reference external" href="http://docs.mongodb.org/manual/reference/operator/query-geospatial/#query-selectors">geospatial query operators</a> and their associated
geometry specifiers are supported. In this example we are using the <a class="reference external" href="http://docs.mongodb.org/manual/reference/operator/query/near/#op._S_near">$near</a>
operator to query for all contacts living in a location within 1000 meters from
a certain point:</p>
<div class="highlight-python"><div class="highlight"><pre>?where={&quot;location&quot;: {&quot;$near&quot;: {&quot;$geometry&quot;: {&quot;type&quot;:&quot;Point&quot;, &quot;coordinates&quot;: [10.0, 20.0]}, &quot;$maxDistance&quot;: 1000}}}
</pre></div>
</div>
<p>Please refer to MongoDB documentation for details on geo queries.</p>
</div>
</div>
<div class="section" id="internal-resources">
<span id="id7"></span><h2>Internal Resources<a class="headerlink" href="#internal-resources" title="Permalink to this headline">¶</a></h2>
<p>By default responses to GET requests to the home endpoint will include all the
resources. The <tt class="docutils literal"><span class="pre">internal_resource</span></tt> setting keyword, however, allows you to
make an endpoint internal, available only for internal data manipulation: no
HTTP calls can be made against it and it will be excluded from the <tt class="docutils literal"><span class="pre">HATEOAS</span></tt>
links.</p>
<p>An usage example would be a mechanism for logging all inserts happening in
the system, something that can be used for auditing or a notification system.
First we define an <tt class="docutils literal"><span class="pre">internal_transaction</span></tt> endpoint, which is flagged as an
<tt class="docutils literal"><span class="pre">internal_resource</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre> <span class="n">internal_transactions</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s">&#39;schema&#39;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s">&#39;entities&#39;</span><span class="p">:</span> <span class="p">{</span>
             <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;list&#39;</span><span class="p">,</span>
         <span class="p">},</span>
         <span class="s">&#39;original_resource&#39;</span><span class="p">:</span> <span class="p">{</span>
             <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;string&#39;</span><span class="p">,</span>
         <span class="p">},</span>
     <span class="p">},</span>
<span class="hll">     <span class="s">&#39;internal_resource&#39;</span><span class="p">:</span> <span class="bp">True</span>
</span> <span class="p">}</span>
</pre></div>
</div>
<p>Now, if we access the home endpoint and <tt class="docutils literal"><span class="pre">HATEOAS</span></tt> is enabled, we won&#8217;t get
the <tt class="docutils literal"><span class="pre">internal-transactions</span></tt> listed (and hitting the endpoint via HTTP will
return a <tt class="docutils literal"><span class="pre">404</span></tt>.) We can use the data layer to access our secret endpoint.
Something like this:</p>
<div class="highlight-python"><div class="highlight"><pre> <span class="kn">from</span> <span class="nn">eve</span> <span class="kn">import</span> <span class="n">Eve</span>

 <span class="k">def</span> <span class="nf">on_generic_inserted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">documents</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">resource</span> <span class="o">!=</span> <span class="s">&#39;internal_transactions&#39;</span><span class="p">:</span>
         <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
         <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
             <span class="s">&#39;entities&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="n">document</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">],</span>
             <span class="s">&#39;original_resource&#39;</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span>
             <span class="n">config</span><span class="o">.</span><span class="n">LAST_UPDATED</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
             <span class="n">config</span><span class="o">.</span><span class="n">DATE_CREATED</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
         <span class="p">}</span>
<span class="hll">         <span class="n">app</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;internal_transactions&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">transaction</span><span class="p">])</span>
</span>
 <span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>
 <span class="n">app</span><span class="o">.</span><span class="n">on_inserted</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_generic_inserted</span>

 <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>I admit that this example is as rudimentary as it can get, but hopefully it
will get the point across.</p>
</div>
<div class="section" id="enhanced-logging">
<span id="logging"></span><h2>Enhanced Logging<a class="headerlink" href="#enhanced-logging" title="Permalink to this headline">¶</a></h2>
<p>A number of events are available for logging via the default application
logger. The standard <a class="reference external" href="https://docs.python.org/2/library/logging.html#logrecord-attributes">LogRecord attributes</a> are extended with a few request
attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">clientip</span></tt></td>
<td>IP address of the client performing the
request.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">url</span></tt></td>
<td>Full request URL, eventual query parameters
included.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">method</span></tt></td>
<td>Request method (<tt class="docutils literal"><span class="pre">POST</span></tt>, <tt class="docutils literal"><span class="pre">GET</span></tt>, etc.)</td>
</tr>
</tbody>
</table>
<p>You can use these fields when logging to a file or any other destination.</p>
<p>Callback functions can also take advantage of the builtin logger. The following
example logs application events to a file, and also logs custom messages every
time a custom function is invoked.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">eve</span> <span class="kn">import</span> <span class="n">Eve</span>

<span class="k">def</span> <span class="nf">log_every_get</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="c"># custom INFO-level message is sent to the log file</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;We just answered to a GET request!&#39;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">on_post_GET</span> <span class="o">+=</span> <span class="n">log_every_get</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c"># enable logging to &#39;app.log&#39; file</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s">&#39;app.log&#39;</span><span class="p">)</span>

    <span class="c"># set a custom log format, and add request</span>
    <span class="c"># metadata to each log line</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
        <span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(levelname)s</span><span class="s">: </span><span class="si">%(message)s</span><span class="s"> &#39;</span>
        <span class="s">&#39;[in </span><span class="si">%(filename)s</span><span class="s">:</span><span class="si">%(lineno)d</span><span class="s">] -- ip: </span><span class="si">%(clientip)s</span><span class="s">, &#39;</span>
        <span class="s">&#39;url: </span><span class="si">%(url)s</span><span class="s">, method:</span><span class="si">%(method)s</span><span class="s">&#39;</span><span class="p">))</span>

    <span class="c"># the default log level is set to WARNING, so</span>
    <span class="c"># we have to explictly set the logging level</span>
    <span class="c"># to INFO to get our custom message logged.</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="c"># append the handler to the default application logger</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="c"># let&#39;s go</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Currently only exceptions raised by the MongoDB layer and <tt class="docutils literal"><span class="pre">POST</span></tt>, <tt class="docutils literal"><span class="pre">PATCH</span></tt>
and <tt class="docutils literal"><span class="pre">PUT</span></tt> methods are logged. The idea is to also add some <tt class="docutils literal"><span class="pre">INFO</span></tt> and
possibly <tt class="docutils literal"><span class="pre">DEBUG</span></tt> level events in the future.</p>
</div>
<div class="section" id="operations-log">
<span id="oplog"></span><h2>Operations Log<a class="headerlink" href="#operations-log" title="Permalink to this headline">¶</a></h2>
<p>The OpLog is an API-wide log of all edit operations. Every <tt class="docutils literal"><span class="pre">POST</span></tt>, <tt class="docutils literal"><span class="pre">PATCH</span></tt>
<tt class="docutils literal"><span class="pre">PUT</span></tt> and <tt class="docutils literal"><span class="pre">DELETE</span></tt> operation can be recorded to the oplog. At its core the
oplog is simply a server log. What makes it a little bit different is that it
can be exposed as a read-only endpoint, thus allowing clients to query it as
they would with any other API endpoint.</p>
<p>Every oplog entry contains informations about the document and the operation:</p>
<ul class="simple">
<li>Operation performed</li>
<li>Unique ID of the document</li>
<li>Update date</li>
<li>Creation date</li>
<li>Resource endpoint URL</li>
<li>User token, if <a class="reference internal" href="authentication.html#user-restricted"><em>User-Restricted Resource Access</em></a> is enabled for the endpoint</li>
<li>Optional custom data</li>
</ul>
<p>Like any other API-maintained document, oplog entries also expose:</p>
<ul class="simple">
<li>Entry ID</li>
<li>ETag</li>
<li>HATEOAS fields if that&#8217;s enabled.</li>
</ul>
<p>If <tt class="docutils literal"><span class="pre">OPLOG_AUDIT</span></tt> is enabled entries also expose:</p>
<ul class="simple">
<li>client IP</li>
<li>Username or token, if available</li>
<li>changes applied to the document (for <tt class="docutils literal"><span class="pre">DELETE</span></tt> the whole document is included).</li>
</ul>
<p>A typical oplog entry looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;o&quot;</span><span class="p">:</span> <span class="s">&quot;DELETE&quot;</span><span class="p">,</span>
    <span class="s">&quot;r&quot;</span><span class="p">:</span> <span class="s">&quot;people&quot;</span><span class="p">,</span>
    <span class="s">&quot;i&quot;</span><span class="p">:</span> <span class="s">&quot;542d118938345b614ea75b3c&quot;</span><span class="p">,</span>
    <span class="s">&quot;c&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">},</span>
    <span class="s">&quot;ip&quot;</span><span class="p">:</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="s">&quot;u&quot;</span><span class="p">:</span> <span class="s">&quot;admin&quot;</span><span class="p">,</span>
    <span class="s">&quot;_updated&quot;</span><span class="p">:</span> <span class="s">&quot;Fri, 03 Oct 2014 08:16:52 GMT&quot;</span><span class="p">,</span>
    <span class="s">&quot;_created&quot;</span><span class="p">:</span> <span class="s">&quot;Fri, 03 Oct 2014 08:16:52 GMT&quot;</span><span class="p">,</span>
    <span class="s">&quot;_etag&quot;</span><span class="p">:</span> <span class="s">&quot;e17218fbca41cb0ee6a5a5933fb9ee4f4ca7e5d6&quot;</span>
    <span class="s">&quot;_id&quot;</span><span class="p">:</span> <span class="s">&quot;542e5b7438345b6dadf95ba5&quot;</span><span class="p">,</span>
    <span class="s">&quot;_links&quot;</span><span class="p">:</span> <span class="p">{</span><span class="o">...</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To save a little space (at least on MongoDB) field names have been shortened:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">o</span></tt> stands for operation performed</li>
<li><tt class="docutils literal"><span class="pre">r</span></tt> stands for resource endpoint</li>
<li><tt class="docutils literal"><span class="pre">i</span></tt> stands for document id</li>
<li><tt class="docutils literal"><span class="pre">ip</span></tt> is the client IP</li>
<li><tt class="docutils literal"><span class="pre">u</span></tt> stands for user (or token)</li>
<li><tt class="docutils literal"><span class="pre">c</span></tt> stands for changes occurred</li>
<li><tt class="docutils literal"><span class="pre">extra</span></tt> is an optional field which you can use to store custom data</li>
</ul>
<p><tt class="docutils literal"><span class="pre">_created</span></tt> and <tt class="docutils literal"><span class="pre">_updated</span></tt> are relative to the target document, which comes
handy in a variety of scenarios (like when the oplog is available to clients,
more on this later).</p>
<p>Please note that by default the <tt class="docutils literal"><span class="pre">c</span></tt> (changes) field is not included for
<tt class="docutils literal"><span class="pre">POST</span></tt> operations. You can add <tt class="docutils literal"><span class="pre">POST</span></tt> to the <tt class="docutils literal"><span class="pre">OPLOG_CHANGE_METHODS</span></tt>
setting (see <a class="reference internal" href="config.html#global"><em>Global Configuration</em></a>) if you whish the whole document to be included on
every insertion.</p>
<div class="section" id="how-is-the-oplog-operated">
<h3>How is the oplog operated?<a class="headerlink" href="#how-is-the-oplog-operated" title="Permalink to this headline">¶</a></h3>
<p>Six settings are dedicated to the OpLog:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">OPLOG</span></tt> switches the oplog feature on and off. Defaults to <tt class="docutils literal"><span class="pre">False</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">OPLOG_NAME</span></tt> is the name of the oplog collection on the database. Defaults to <tt class="docutils literal"><span class="pre">oplog</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">OPLOG_METHODS</span></tt> is a list of HTTP methods to be logged. Defaults to all of them.</li>
<li><tt class="docutils literal"><span class="pre">OPLOG_ENDPOINT</span></tt> is the endpoint name. Defaults to <tt class="docutils literal"><span class="pre">None</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">OPLOG_AUDIT</span></tt> if enabled, IP addresses and changes are also logged. Defaults to <tt class="docutils literal"><span class="pre">True</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">OPLOG_CHANGE_METHODS</span></tt> determines which methods will log changes. Defaults to [&#8216;PATCH&#8217;, &#8216;PUT&#8217;, &#8216;DELETE&#8217;].</li>
<li><tt class="docutils literal"><span class="pre">OPLOG_RETURN_EXTRA_FIELD</span></tt> determines if the optional <tt class="docutils literal"><span class="pre">extra</span></tt> field
should be returned by the <tt class="docutils literal"><span class="pre">OPLOG_ENDPOINT</span></tt>. Defaults to <tt class="docutils literal"><span class="pre">False</span></tt>.</li>
</ul>
<p>As you can see the oplog feature is turned off by default. Also, since
<tt class="docutils literal"><span class="pre">OPLOG_ENDPOINT</span></tt> defaults to <tt class="docutils literal"><span class="pre">None</span></tt>, even if you switch the feature on no
public oplog endpoint will be available. You will have to explictly set the
endpoint name in order to expose your oplog to the public.</p>
</div>
<div class="section" id="the-oplog-endpoint">
<h3>The Oplog endpoint<a class="headerlink" href="#the-oplog-endpoint" title="Permalink to this headline">¶</a></h3>
<p>Since the oplog endpoint is nothing but a standard API endpoint, you can
customize it. This allows for setting up custom authentication (you might want
this resource to be only accessible for administrative purposes) or any other
useful setting.</p>
<p>Note that while you can change most of its settings, the endpoint will always
be read-only so setting either <tt class="docutils literal"><span class="pre">resource_methods</span></tt> or <tt class="docutils literal"><span class="pre">item_methods</span></tt> to
something other than <tt class="docutils literal"><span class="pre">['GET']</span></tt> will serve no purpose. Also, unless you need to
customize it, adding an oplog entry to the domain is not really necessary as it
will be added for you automatically.</p>
<p>Exposing the oplog as an endpoint could be useful in scenarios where you have
multiple clients (say phone, tablet, web and desktop apps) which need to stay
in sync with each other and the server. Instead of hitting every single
endpoint they could just access the oplog to learn all that&#8217;s happened
since their last access. That’s a single request versus several. This is not
always the best approach a client could take. Sometimes it is probably better
to only query for changes on a certain endpoint. That&#8217;s also possible, just
query the oplog for changes occured on that endpoint.</p>
</div>
<div class="section" id="extending-oplog-entries">
<h3>Extending Oplog entries<a class="headerlink" href="#extending-oplog-entries" title="Permalink to this headline">¶</a></h3>
<p>Every time the oplog is about to be updated the <tt class="docutils literal"><span class="pre">on_oplog_push</span></tt> event is fired.
You can hook one or more callback functions to this event. Callbacks receive
<tt class="docutils literal"><span class="pre">resource</span></tt> and <tt class="docutils literal"><span class="pre">entries</span></tt> as arguments. The former is the resource name
while the latter is a list of oplog entries which are about to be written to
disk.</p>
<p>Your callback can add an optional <tt class="docutils literal"><span class="pre">extra</span></tt> field to canonical oplog entries.
The field can be of any type. In this example we are adding a custom dict to
each entry:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">oplog_extras</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">entries</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="n">entry</span><span class="p">[</span><span class="s">&#39;extra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;myfield&#39;</span><span class="p">:</span> <span class="s">&#39;myvalue&#39;</span><span class="p">}</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">on_oplog_push</span> <span class="o">+=</span> <span class="n">oplog_extras</span>
<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Please note that unless you explictly set <tt class="docutils literal"><span class="pre">OPLOG_RETURN_EXTRA_FIELD</span></tt> to
<tt class="docutils literal"><span class="pre">True</span></tt>, the <tt class="docutils literal"><span class="pre">extra</span></tt> field will <em>not</em> be returned by the <tt class="docutils literal"><span class="pre">OPLOG_ENDPOINT</span></tt>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Are you on MongoDB? Consider making the oplog a <a class="reference external" href="http://docs.mongodb.org/manual/core/capped-collections/">capped collection</a>. Also,
in case you are wondering yes, the Eve oplog is blatantly inpsired by the
awesome <a class="reference external" href="http://docs.mongodb.org/manual/core/replica-set-oplog/">Replica Set Oplog</a>.</p>
</div>
</div>
</div>
<div class="section" id="the-schema-endpoint">
<span id="schema-endpoint"></span><h2>The Schema Endpoint<a class="headerlink" href="#the-schema-endpoint" title="Permalink to this headline">¶</a></h2>
<p>Resource schema can be exposed to API clients by enabling Eve&#8217;s schema
endpoint. To do so, set the <tt class="docutils literal"><span class="pre">SCHEMA_ENDPOINT</span></tt> configuration option to the API
endpoint name from which you want to serve schema data. Once enabled, Eve will
treat the endpoint as a read only resource containing JSON encoded Cerberus
schema definitons, indexed by resource name. Resource visibility and
authorization settings are honored, so internal resources or resources for
which a request does not have read authentication will not be accessible at the
schema endpoint. By default, <tt class="docutils literal"><span class="pre">SCHEMA_ENDPOINT</span></tt> is set to <tt class="docutils literal"><span class="pre">None</span></tt>.</p>
</div>
<div class="section" id="mongodb-aggregation-framework">
<span id="aggregation"></span><h2>MongoDB Aggregation Framework<a class="headerlink" href="#mongodb-aggregation-framework" title="Permalink to this headline">¶</a></h2>
<p>Support for the <a class="reference external" href="https://docs.mongodb.org/v3.0/applications/aggregation/">MongoDB Aggregation Framework</a> is built-in. In the example
below (taken from PyMongo) we’ll perform a simple aggregation to count the
number of occurrences for each tag in the tags array, across the entire
collection. To achieve this we need to pass in three operations to the
pipeline. First, we need to unwind the tags array, then group by the tags and
sum them up, finally we sort by count.</p>
<p>As python dictionaries don’t maintain order you should use <tt class="docutils literal"><span class="pre">SON</span></tt> or
collections <tt class="docutils literal"><span class="pre">OrderedDict</span></tt> where explicit ordering is required eg <tt class="docutils literal"><span class="pre">$sort</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">posts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;datasource&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;aggregation&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;pipeline&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s">&quot;$tags&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span> <span class="s">&quot;$tags&quot;</span><span class="p">,</span> <span class="s">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
                <span class="p">{</span><span class="s">&quot;$sort&quot;</span><span class="p">:</span> <span class="n">SON</span><span class="p">([(</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The pipeline above is static. You have the option to allow for dynamic
pipelines, whereas the client will directly influence the aggregation results.
Let&#8217;s update the pipeline a little bit:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">posts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;datasource&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;aggregation&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;pipeline&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&quot;$unwind&quot;</span><span class="p">:</span> <span class="s">&quot;$tags&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span> <span class="s">&quot;$tags&quot;</span><span class="p">,</span> <span class="s">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;$sum&quot;</span><span class="p">:</span> <span class="s">&quot;$value&quot;</span><span class="p">}}},</span>
                <span class="p">{</span><span class="s">&quot;$sort&quot;</span><span class="p">:</span> <span class="n">SON</span><span class="p">([(</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see the <cite>count</cite> field is now going to sum the value of <tt class="docutils literal"><span class="pre">$value</span></tt>,
which will be set by the client upon perfoming the request:</p>
<div class="highlight-python"><div class="highlight"><pre>$ curl -i http://example.com/posts?aggregate={&quot;$value&quot;: 2}
</pre></div>
</div>
<p>The request above will cause the aggregation to be executed on the server with
a <cite>count</cite> field configured as if it was a static <tt class="docutils literal"><span class="pre">{&quot;$sum&quot;:</span> <span class="pre">2}</span></tt>. The client
simply adds the <tt class="docutils literal"><span class="pre">aggregate</span></tt> query parameter and then passes a dictionary with
field/value pairs. Like with all other keywords, you can change <tt class="docutils literal"><span class="pre">aggregate</span></tt>
to a keyword of your liking, just set <tt class="docutils literal"><span class="pre">QUERY_AGGREGATION</span></tt> in your settings.</p>
<p>You can also set all options natively supported by PyMongo. For more
informations on aggregation see <a class="reference internal" href="config.html#datasource"><em>Advanced Datasource Patterns</em></a>.</p>
<p>Custom callback functions can be attached to the <tt class="docutils literal"><span class="pre">before_aggregation</span></tt> and <tt class="docutils literal"><span class="pre">after_aggregation</span></tt> event hooks. For more information, see <a class="reference internal" href="#aggregation-hooks"><em>Aggregation event hooks</em></a>.</p>
<div class="section" id="id8">
<h3>Limitations<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">HATEOAS</span></tt> is not available at aggregation endpoints. This should not
be surprising as documents returned by these endpoints are aggregation results
and do not reside on the database, so there is no static link available for them.</p>
<p>Client pagination (<tt class="docutils literal"><span class="pre">?page=2</span></tt>) is enabled by default. This is currently
achieved by injecting two additional stages (<tt class="docutils literal"><span class="pre">$limit</span></tt> first, then <tt class="docutils literal"><span class="pre">$skip</span></tt>)
to the very end of the aggregation pipeline. You can turn pagination off by setting
<tt class="docutils literal"><span class="pre">pagination</span></tt> to <tt class="docutils literal"><span class="pre">False</span></tt> for the endpoint. Keep in mind that, when pagination
is disabled, all aggregation results are included with every response.
Disabling pagination might be appropriate (and actually advisable) only if the
expected response payload is not huge.</p>
<p>Client sorting (<tt class="docutils literal"><span class="pre">?sort=field1</span></tt>) is not supported at aggregation endpoints.
You can of course add one or more <tt class="docutils literal"><span class="pre">$sort</span></tt> stages to the pipeline, as we did
with the example above. If you do add a <tt class="docutils literal"><span class="pre">$sort</span></tt> stage to the pipeline,
consider adding it at the end of the pipeline. According to MongoDB&#8217;s <tt class="docutils literal"><span class="pre">$limit</span></tt>
documentation (<a class="reference external" href="https://docs.mongodb.org/manual/reference/operator/aggregation/limit/">link</a>):</p>
<blockquote>
<div>When a <tt class="docutils literal"><span class="pre">$sort</span></tt> immediately precedes a <tt class="docutils literal"><span class="pre">$limit</span></tt> in the pipeline, the
sort operation only maintains the top <strong>n</strong> results as it progresses, where
<strong>n</strong> is the specified limit, and MongoDB only needs to store <strong>n</strong> items
in memory.</div></blockquote>
<p>As we just saw earlier, pagination adds a <tt class="docutils literal"><span class="pre">$limit</span></tt> stage to the end of the
pipeline. So if pagination is enabled and <tt class="docutils literal"><span class="pre">$sort</span></tt> is the last stage of your
pipeline, then the resulting combined pipeline should be optimized.</p>
<p>A single endpoint cannot serve both regular and aggregation results. However,
since it is possible to setup multiple endpoints all serving from the same
datasource (see <a class="reference internal" href="config.html#source"><em>Multiple API Endpoints, One Datasource</em></a>), similar functionality can be easily achieved.</p>
</div>
</div>
<div class="section" id="mongodb-and-sql-support">
<h2>MongoDB and SQL Support<a class="headerlink" href="#mongodb-and-sql-support" title="Permalink to this headline">¶</a></h2>
<p>Support for single or multiple MongoDB database/servers comes out of the box.
An SQLAlchemy extension provides support for SQL backends. Additional data
layers can can be developed with relative ease. Visit the <a class="reference external" href="http://python-eve.org/extensions">extensions page</a>
for a list of community developed data layers and extensions.</p>
</div>
<div class="section" id="powered-by-flask">
<h2>Powered by Flask<a class="headerlink" href="#powered-by-flask" title="Permalink to this headline">¶</a></h2>
<p>Eve is based on the <a class="reference external" href="http://flask.pocoo.org">Flask</a> micro web framework. Actually, Eve itself is
a Flask subclass, which means that Eve exposes all of Flask functionalities and
niceties, like a built-in development server and <a class="reference external" href="http://flask.pocoo.org/docs/quickstart/#debug-mode">debugger</a>, integrated support
for <a class="reference external" href="http://flask.pocoo.org/docs/testing/">unittesting</a> and an <a class="reference external" href="http://flask.pocoo.org/docs/">extensive documentation</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/eve_leaf.png" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=pyeve&repo=eve&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Stay Informed</h3>
<p>Receive updates on new releases and upcoming projects.</p>

<p><a href="https://twitter.com/nicolaiarocci" class="twitter-follow-button" data-show-count="false">Follow @nicolaiarocci</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></p>

<p><iframe src="http://ghbtns.com/github-btn.html?user=nicolaiarocci&type=follow&count=false"
  allowtransparency="true" frameborder="0" scrolling="0" width="200" height="20"></iframe></p>

<p><a href="http://tinyletter.com/nicolaiarocci">Join Mailing List</a>.</p>

<h3>Eve Course</h3>
<p>This course will teach you how to build RESTful services with Eve and MongoDB.</p>
<p>The teacher is the project creator and maintainer.</p>
<ul>
  <li><a href="https://training.talkpython.fm/courses/explore_eve/eve-building-restful-mongodb-backed-apis-course">Eve Course @ TalkPython</a></li>
</ul>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://github.com/pyeve/eve">Eve @ GitHub</a></li>
  <li><a href="https://stackoverflow.com/questions/tagged/eve">Eve @ Stack Overflow</a></li>
  <li><a href="https://groups.google.com/forum/?hl=en#!forum/python-eve">Eve @ Google Groups</a></li>
  <li><a href="irc://irc.freenode.net/python-eve">Eve @ IRC</a>
  <li><a href="https://pypi.python.org/pypi/eve">Eve @ PyPI</a></li>
  <li><a href="https://nicolaiarocci.com/tags/eve/">Eve @ Nicola Iarocci</a></li>
  <li><a href="https://github.com/pyeve/eve/issues">Issue Tracker</a></li>
</ul>

<h3>Other Projects</h3>

<p>More <a href="http://nicolaiarocci.com/">Nicola Iarocci</a> projects:</p>
<ul>
    <li><a href="http://python-cerberus.org/">Cerberus</a></li>
    <li><a href="https://github.com/pyeve/events">Events</a></li>
    <li><a href="https://github.com/pyeve/flask-sentinel">Flask-Sentinel</a></li>
    <li><a href="https://github.com/nicolaiarocci/flask-mimerender">Flask-MimeRender</a></li>
    <li><a href="https://github.com/pyeve/eve-demo">Eve-Demo</a></li>
    <li><a href="https://github.com/pyeve/eve-demo-client">Eve-Demo Client</a></li>
    <li><a href="https://github.com/pyeve/eve-swagger">Eve-Swagger</a></li>
    <li><a href="https://github.com/pyeve/eve-oauth2">Eve-OAuth2</a></li>
</ul>

<p>You are looking at the documentation of the development version.</p><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="foreword.html">Foreword</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest_api_for_humans.html">REST API for Humans</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#emphasis-on-rest">Emphasis on REST</a></li>
<li class="toctree-l2"><a class="reference internal" href="#full-range-of-crud-operations">Full range of CRUD operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overriding-http-methods">Overriding HTTP Methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#customizable-resource-endpoints">Customizable resource endpoints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sub-resources">Sub Resources</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#customizable-multiple-item-endpoints">Customizable, multiple item endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="#filtering">Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pretty-printing">Pretty Printing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sorting">Sorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pagination">Pagination</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hateoas">HATEOAS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#disabling-hateoas">Disabling HATEOAS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#rendering">Rendering</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conditional-requests">Conditional Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-integrity-and-concurrency-control">Data Integrity and Concurrency Control</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#disabling-concurrency-control">Disabling concurrency control</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#bulk-inserts">Bulk Inserts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-validation">Data Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extensible-data-validation">Extensible Data Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resource-level-cache-control">Resource-level Cache Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api-versioning">API Versioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="#document-versioning">Document Versioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="#authentication">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cors-cross-origin-resource-sharing">CORS Cross-Origin Resource Sharing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jsonp-support">JSONP Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="#read-only-by-default">Read-only by default</a></li>
<li class="toctree-l2"><a class="reference internal" href="#default-and-nullable-values">Default and Nullable Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="#predefined-database-filters">Predefined Database Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#projections">Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="#embedded-resource-serialization">Embedded Resource Serialization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#predefined-resource-serialization">Predefined Resource Serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#soft-delete">Soft Delete</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#behavior">Behavior</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restoring-soft-deleted-items">Restoring Soft Deleted Items</a></li>
<li class="toctree-l3"><a class="reference internal" href="#versioning">Versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-relations">Data Relations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#considerations">Considerations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#event-hooks">Event Hooks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pre-request-event-hooks">Pre-Request Event Hooks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dynamic-lookup-filters">Dynamic Lookup Filters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#post-request-event-hooks">Post-Request Event Hooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-event-hooks">Database event hooks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fetch-events">Fetch Events</a></li>
<li class="toctree-l4"><a class="reference internal" href="#insert-events">Insert Events</a></li>
<li class="toctree-l4"><a class="reference internal" href="#replace-events">Replace Events</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-events">Update Events</a></li>
<li class="toctree-l4"><a class="reference internal" href="#delete-events">Delete Events</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#items">Items</a></li>
<li class="toctree-l5"><a class="reference internal" href="#resources">Resources</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#aggregation-event-hooks">Aggregation event hooks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#rate-limiting">Rate Limiting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-id-fields">Custom ID Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="#file-storage">File Storage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#serving-media-files-as-base64-strings">Serving media files as Base64 strings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#serving-media-files-at-a-dedicated-endpoint">Serving media files at a dedicated endpoint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#partial-media-downloads">Partial media downloads</a></li>
<li class="toctree-l3"><a class="reference internal" href="#leveraging-projections-to-optimize-the-handling-of-media-files">Leveraging Projections to optimize the handling of media files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#note-on-media-files-as-multipart-form-data">Note on media files as <tt class="docutils literal"><span class="pre">multipart/form-data</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-lists-of-media">Using lists of media</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#geojson">GeoJSON</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#querying-geojson-data">Querying GeoJSON Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#internal-resources">Internal Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enhanced-logging">Enhanced Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#operations-log">Operations Log</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-is-the-oplog-operated">How is the oplog operated?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-oplog-endpoint">The Oplog endpoint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extending-oplog-entries">Extending Oplog entries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-schema-endpoint">The Schema Endpoint</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mongodb-aggregation-framework">MongoDB Aggregation Framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">Limitations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mongodb-and-sql-support">MongoDB and SQL Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="#powered-by-flask">Powered by Flask</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="validation.html">Data Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="authentication.html">Authentication and Authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="funding.html">Funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="snippets/index.html">Snippets</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="updates.html">Updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>


<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p>
Artwork by <a href="http://kalamun.org">Kalamun</a> © 2013
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
      &copy;2018. Python-Eve is a <a href="http://nicolaiarocci.com">Nicola Iarocci</a> Project.
      
    </div>

    
    <a href="https://github.com/pyeve/eve" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="_static/forkme_right_green_007200.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19006041-6', 'auto');
    ga('send', 'pageview');

</script>

  </body>
</html>